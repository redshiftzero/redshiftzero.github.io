<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark">
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>A pytest fixture for image similarity | redshiftzero</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/modern.css" />

    <!-- JavaScript -->
    <script src="/js/meme.min.238001acc8d107d31839007c618ccd38c64210ddf0869d445de90497fdbe5861.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap"
        media="print" onload="this.media='all'" />
    <noscript>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" />
    </noscript>

    <!-- Meta tags -->
    <meta name="author" content="" />
    <meta name="description" content="A pytest fixture for image similarity" />

    <!-- Icons and manifest -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="redshiftzero" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="redshiftzero" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="/icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- RSS feeds -->
    <link rel="alternate" type="application/atom+xml" href="https://www.redshiftzero.com/atom.xml"
        title="redshiftzero" />
    <link rel="alternate" type="application/rss+xml" href="https://www.redshiftzero.com/rss.xml" title="redshiftzero" />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.redshiftzero.com/post/pytest-image/" />

    <!-- Open Graph -->
    <meta property="og:title" content="A pytest fixture for image similarity | redshiftzero" />
    <meta property="og:description" content="A pytest fixture for image similarity" />
    <meta property="og:url" content="https://www.redshiftzero.com/post/pytest-image/" />
    <meta property="og:site_name" content="redshiftzero" />
    <meta property="og:locale" content="en" />
    <meta property="og:image" content="https://www.redshiftzero.com/icons/apple-touch-icon.png" />
    <meta property="og:type" content="article" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@redshiftzero" />

    <!-- JSON-LD structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "datePublished": "2020-01-12T00:00:00",
        "dateModified": "2020-01-12T00:00:00",
        "url": "https://www.redshiftzero.com/post/pytest-image/",
        "description": "A pytest fixture for image similarity",
        "image": "https://www.redshiftzero.com/icons/apple-touch-icon.png",
        "author": {
            "@type": "Person",
            "url": "https://www.redshiftzero.com/"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)",
        "name": "A pytest fixture for image similarity | redshiftzero"
    }
    </script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-wrapper">
                <div class="header-inner single">
                    <div class="site-brand">
                        <a href="/" class="brand">redshiftzero</a>
                    </div>

                    <nav class="nav">
                        <ul class="menu" id="menu">

                            <li class="menu-item"><a href="/archive/"><svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 512 512" class="icon archive">
                                        <path
                                            d="M32 32C14.3 32 0 46.3 0 64s14.3 32 32 32h32v32H32C14.3 128 0 142.3 0 160s14.3 32 32 32h32v32H32C14.3 224 0 238.3 0 256s14.3 32 32 32h32v32H32C14.3 320 0 334.3 0 352s14.3 32 32 32h32v32H32C14.3 416 0 430.3 0 448s14.3 32 32 32h448c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32V96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32H32zM96 96h320v320H96V96z" />
                                    </svg><span class="menu-item-name">Archive</span></a></li>
                            <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 496 512" class="icon user-circle">
                                        <path
                                            d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z" />
                                    </svg><span class="menu-item-name">About</span></a></li>

                        </ul>
                    </nav>
                </div>
            </div>
            <input type="checkbox" id="nav-toggle" aria-hidden="true" />
            <label for="nav-toggle" class="nav-toggle"></label>
            <label for="nav-toggle" class="nav-curtain"></label>
        </header>

        <!-- Main content -->
        <main class="main single" id="main">
            <div class="main-inner">
                
                <article class="content post h-entry">
                    <h1 class="post-title p-name">A pytest fixture for image similarity</h1>

                    <div class="post-meta">
                        <time datetime="2020-01-12T00:00:00" class="post-meta-item published dt-published">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon">
                                <path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/>
                            </svg> 2020.01.12
                        </time>
                    </div>

                    <div class="post-body e-content">
                        <p>When testing codepaths that generate images, one might want to ensure that the generated image is what is expected. <a href="https://matplotlib.org">Matplotlib</a> has a nice decorator <a href="https://matplotlib.org/devel/testing.html#writing-an-image-comparison-test"><code>@image_comparison</code></a> that can be applied for this purpose, but looking at <a href="https://github.com/matplotlib/matplotlib/blob/f653879c6317b191849c49511282cfff949ad336/lib/matplotlib/testing/decorators.py#L165">the implementation</a>, it's pretty tied to the <code>matplotlib</code> <code>Figure</code> object. I wanted something generic to use with PNGs. </p>
<p>I ended up writing a pytest fixture that would compare the image generated during the test with a baseline image (in <code>tests/baseline_images</code> as in the matplotlib implementatino). Here are the contents of <code>conftest.py</code>, which contain the fixture and its related image similarity assert:</p>
<pre class="codehilite"><code class="language-py">import os
import pytest
import numpy as np
from PIL import Image


def assert_images_equal(image_1: str, image_2: str):
    img1 = Image.open(image_1)
    img2 = Image.open(image_2)

    # Convert to same mode and size for comparison
    img2 = img2.convert(img1.mode)
    img2 = img2.resize(img1.size)

    sum_sq_diff = np.sum((np.asarray(img1).astype('float') - np.asarray(img2).astype('float'))**2)

    if sum_sq_diff == 0:
        # Images are exactly the same
        pass
    else:
        normalized_sum_sq_diff = sum_sq_diff / np.sqrt(sum_sq_diff)
        assert normalized_sum_sq_diff &lt; 0.001


@pytest.fixture
def image_similarity(request, tmpdir):
    testname = request.node.name
    filename = &quot;{}.png&quot;.format(testname)
    generated_file = os.path.join(str(tmpdir), &quot;{}.png&quot;.format(testname))

    yield {'filename': generated_file}

    assert_images_equal(&quot;tests/baseline_images/{}.png&quot;.format(testname), generated_file)
</code></pre>

<p>The assert rescales the images to be the same size, as well as the same mode, and then computes the sum of the squared differences as an image similarity metric.</p>
<p>You can use the above fixture in a test via:</p>
<pre class="codehilite"><code class="language-py">def test_example(image_similarity):
    # test logic goes here and should generate an image in the
    # path given by image_similarity['filename']
    pass
</code></pre>

<p>When you add a new test, you need to add the expected image to <code>tests/baseline_images/&lt;testname&gt;.png</code>.</p>
                    </div>
                </article>
            
            </div>
        </main>

        <!-- Back to top -->
        <div id="back-to-top" class="back-to-top">
            <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up">
                    <path
                        d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z" />
                </svg></a>
        </div>

        <!-- Footer -->
        <footer id="footer" class="footer">
            <div class="footer-inner">
                <div class="site-info">© 2025 Jennifer Helsby</div>
            </div>
        </footer>
    </div>

    <!-- MathJax -->
    <script>
        if (typeof MathJax === 'undefined') {
            window.MathJax = {
                loader: {
                    load: ['[tex]/mhchem']
                },
                tex: {
                    inlineMath: { '[+]': [['$', '$']] },
                    tags: 'ams',
                    packages: { '[+]': ['mhchem'] }
                }
            };
            (function () {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
                script.defer = true;
                document.head.appendChild(script);
            })();
        } else {
            MathJax.texReset();
            MathJax.typeset();
        }
    </script>

    <!-- Medium Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>
    <script>
        let imgNodes = document.querySelectorAll('div.post-body img');
        imgNodes = Array.from(imgNodes).filter(node => node.parentNode.tagName !== "A");

        mediumZoom(imgNodes, {
            background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
        })
    </script>

    <!-- Instant Page -->
    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>
</body>

</html>