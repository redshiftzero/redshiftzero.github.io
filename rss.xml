<?xml version="1.0" encoding="utf-8"?>






<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>redshiftzero</title>
        <link>https://www.redshiftzero.com/</link>
        <description>MemE is a powerful and highly customizable GoHugo theme for personal blogs.</description>
        <generator>Hugo 0.102.3 https://gohugo.io/</generator>
        
            <language>en</language>
        
        
            <managingEditor>jen@redshiftzero.com (redshiftzero)</managingEditor>
        
        
            <webMaster>jen@redshiftzero.com (redshiftzero)</webMaster>
        
        
            <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
        
        <lastBuildDate>Mon, 05 Sep 2022 19:03:58 -0400</lastBuildDate>
        
            <atom:link rel="self" type="application/rss&#43;xml" href="https://www.redshiftzero.com/rss.xml" />
        
        
            <item>
                <title>Commitment Schemes 101</title>
                <link>https://www.redshiftzero.com/post/commitments/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/commitments/</guid>
                <pubDate>Mon, 05 Sep 2022 18:50:23 -0400</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;This is a simple explanation of cryptographic &lt;em&gt;commitment schemes&lt;/em&gt;, requiring minimal math or
cryptography background.&lt;/p&gt;
&lt;h2 id=&#34;what-is-a-commitment-scheme&#34;&gt;What is a commitment scheme?&lt;/h2&gt;
&lt;p&gt;A commitment scheme is effectively a cryptographic envelope. I can put a secret value in an envelope and then seal the envelope. We call this &lt;em&gt;committing&lt;/em&gt; to the secret value. And then
I send the envelope to someone or put it somewhere I cannot tamper with it, to open
and reveal the secret value I committed to at some later time.&lt;/p&gt;
&lt;p&gt;The two important properties of this scheme are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Hiding&lt;/strong&gt;: No one can see inside the envelope until it is opened.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Binding&lt;/strong&gt;: Once I have commited to this secret value and sent it, I cannot
change the value. The commitment has &lt;em&gt;bound&lt;/em&gt; me to a specific value.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is an imperfect analogy, but it gets across these two important
properties of commitment schemes.&lt;/p&gt;
&lt;h2 id=&#34;cryptographic-commitments&#34;&gt;Cryptographic Commitments&lt;/h2&gt;
&lt;p&gt;For &lt;em&gt;cryptographic&lt;/em&gt; commitments, we&amp;rsquo;re going to need two algorithms: &lt;code&gt;Commit&lt;/code&gt; and &lt;code&gt;Verify&lt;/code&gt;. Let&amp;rsquo;s go through each one now.&lt;/p&gt;
&lt;h3 id=&#34;commit&#34;&gt;&lt;code&gt;Commit&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;The &lt;code&gt;Commit&lt;/code&gt; algorithm lets us create commitments. Let&amp;rsquo;s call a commitment &lt;code&gt;com&lt;/code&gt;. To commit to a value &lt;code&gt;value&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;com = Commit(value, randomness)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;randomness&lt;/code&gt; is another secret value, but one picked randomly, hence the name. The result &lt;code&gt;com&lt;/code&gt; is what we&amp;rsquo;ll send or broadcast, i.e. &lt;code&gt;com&lt;/code&gt; is our sealed envelope.&lt;/p&gt;
&lt;h3 id=&#34;verify&#34;&gt;&lt;code&gt;Verify&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;When we&amp;rsquo;re ready to open the commitment, anyone can verify the commitment
was opened correctly once they get the values for &lt;code&gt;value&lt;/code&gt; and &lt;code&gt;randomness&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Verify(value, com, randomness) = [accept, reject]&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The result of the &lt;code&gt;Verify&lt;/code&gt; algorithm is either to accept or reject the opening as valid.&lt;/p&gt;
&lt;h3 id=&#34;hiding-and-binding&#34;&gt;Hiding and Binding&lt;/h3&gt;
&lt;p&gt;Remember that we wanted our commitment scheme to share the security properties
as the toy example: hiding and binding. For this cryptographic scheme, what
does this mean a bit more concretely?&lt;/p&gt;
&lt;h4 id=&#34;hiding&#34;&gt;Hiding&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;com&lt;/code&gt; should not reveal &lt;em&gt;anything&lt;/em&gt; about the committed secret &lt;code&gt;value&lt;/code&gt;. You should not be able to see inside the envelope.&lt;/p&gt;
&lt;h4 id=&#34;binding&#34;&gt;Binding&lt;/h4&gt;
&lt;p&gt;Given a commitment &lt;code&gt;com = Commit(value_1, randomness_1)&lt;/code&gt; it should not be possible to find
another valid opening, i.e. another &lt;code&gt;value_2&lt;/code&gt; and &lt;code&gt;randomness_2&lt;/code&gt; such that &lt;code&gt;com = Commit(value_2, randomness_2)&lt;/code&gt;, where we exclude the trivial &lt;code&gt;value_2 != value_1&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;hash-commitments&#34;&gt;Hash Commitments&lt;/h2&gt;
&lt;p&gt;Now let&amp;rsquo;s turn to some ways to make real cryptographic commitment schemes.&lt;/p&gt;
&lt;p&gt;We can make a commitment scheme from a collision-resistant hash function &lt;code&gt;H()&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Our commitment will be generated by simply hashing our value and randomness:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;com = H(value, randomness)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;And then we can verify openings using:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;H(value, randomness) == com&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;If H is collision-resistant, then the scheme is binding. Because if you can find
a second valid opening, then you&amp;rsquo;ve found a collision in &lt;code&gt;H&lt;/code&gt; and it is not collision-resistant.&lt;/p&gt;
&lt;p&gt;If H produces random outputs, then you learn nothing about &lt;code&gt;value&lt;/code&gt;, so the scheme is
hiding.&lt;/p&gt;
&lt;h2 id=&#34;pedersen-commitments&#34;&gt;Pedersen Commitments&lt;/h2&gt;
&lt;p&gt;Given a finite cyclic group, such as an elliptic curve group, we can compute:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;com = Commit(value, randomness) = [value]G + [randomness]H&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;G&lt;/code&gt; and &lt;code&gt;H&lt;/code&gt; are two points from the elliptic curve group, and &lt;code&gt;value&lt;/code&gt; and &lt;code&gt;randomness&lt;/code&gt; are scalars.&lt;/p&gt;
&lt;p&gt;We get another elliptic curve point as a result.&lt;/p&gt;
&lt;p&gt;We can then verify by checking:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[value]G + [randomness]H == com&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;One handy feature about Pedersen commitments is that they are &lt;em&gt;homomorphically
additive&lt;/em&gt;. This means when we add the commitments, we get the commitment of the sum of the values we committed to: all without knowing the secret values.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s show this. Given two commitments &lt;code&gt;com_1 = Commit(v_1, r_1)&lt;/code&gt; and &lt;code&gt;com_2 = Commit(v_2, r_2)&lt;/code&gt;:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;com_1 + com_2
= [v_1]G + [r_1]H + [v_2]G + [r_2]H
= [v_1 + v_2]G + [r_1 + r_2]H 
= Commit(v_1 + v_2, r_1 + r_2)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We end up with the commitment to the sum of the input secret values.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/cryptography/">Cryptography</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/commitment-schemes/">commitment schemes</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/cryptography/">cryptography</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Getting started in Rust and WebAssembly</title>
                <link>https://www.redshiftzero.com/post/webassembly/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/webassembly/</guid>
                <pubDate>Thu, 17 Dec 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;In my last post I described how I implemented the &lt;a href=&#34;https://github.com/freedomofpress/signal-protocol&#34;&gt;&lt;code&gt;signal-protocol&lt;/code&gt;&lt;/a&gt; Python library, which provides Python bindings using &lt;a href=&#34;https://github.com/PyO3/PyO3&#34;&gt;Pyo3&lt;/a&gt; to an upstream maintained Rust cryptography crate implementing the Signal protocol. I created the the &lt;a href=&#34;https://github.com/freedomofpress/signal-protocol&#34;&gt;&lt;code&gt;signal-protocol&lt;/code&gt;&lt;/a&gt; library in order to prototype end-to-end encrypted messaging between journalists and their sources through SecureDrop. In the SecureDrop ecosystem, journalists use a Python project, &lt;a href=&#34;https://github.com/freedomofpress/securedrop-client&#34;&gt;&lt;code&gt;securedrop-client&lt;/code&gt;&lt;/a&gt;, hence the need for the Python bindings, and sources use &lt;a href=&#34;http://torproject.org/&#34;&gt;Tor Browser&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For the Tor Browser-based client for sources, I needed to either use another implementation of Signal in JavaScript (which does exist), or just write a crate that has the existing upstream cryptography crate as a dependency, and compile it all to WebAssembly. As you can probably tell from the title of this post, &lt;a href=&#34;https://github.com/freedomofpress/securedrop-e2e/tree/main/securedrop-source&#34;&gt;I went with the latter approach&lt;/a&gt;. It&amp;rsquo;s honestly pretty cool that I can use the same Rust crypto logic fairly easily for both endpoints, thanks to Pyo3 and WebAssembly.&lt;/p&gt;
&lt;p&gt;In this brief post we&amp;rsquo;ll cover:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#wat&#34;&gt;an intro to WebAssembly&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#wasmbindgen&#34;&gt;where &lt;code&gt;wasm-bindgen&lt;/code&gt; and &lt;code&gt;wasm-pack&lt;/code&gt; fit in&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#useful&#34;&gt;useful crates you should know of, including &lt;code&gt;js_sys&lt;/code&gt; and &lt;code&gt;web_sys&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#refs&#34;&gt;helpful references to read more&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;wat&#34;&gt;WebAssembly?&lt;/h1&gt;
&lt;p&gt;WebAssembly is a binary-code format that runs in a stack-based virtual machine. It&amp;rsquo;s supported in all modern browsers, and can also be run in other runtimes (e.g. see &lt;a href=&#34;https://wasi.dev/&#34;&gt;WASI&lt;/a&gt;) that are browser independent.&lt;/p&gt;
&lt;p&gt;Why use WebAssembly? Two of the most common reasons are portability and performance. For computationally intensive tasks that need to run in a Browser, you might rewrite the expensive parts in a language that compiles to WebAssembly, leaving the rest of your JavaScript unmodified (similar to C extensions and Python). In the case of Rust compiled to WebAssembly, we also get to benefit from all the safety guarantees that Rust provides at compile time.&lt;/p&gt;
&lt;p&gt;There are two main approaches to combining Rust and WebAssembly:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;writing a mix of JavaScript and Rust. Folks typically use &lt;code&gt;wasm-bindgen&lt;/code&gt; and &lt;code&gt;wasm-pack&lt;/code&gt; to make this easy and autogenerate a lot of the helper JavaScript code for your WebAssembly module. We&amp;rsquo;ll cover this below.&lt;/li&gt;
&lt;li&gt;writing only Rust using a project like &lt;a href=&#34;https://github.com/yewstack/yew&#34;&gt;Yew&lt;/a&gt;. Note that you&amp;rsquo;re not sidestepping the use of JavaScript, it&amp;rsquo;s just abstracted away from you so you don&amp;rsquo;t need to write any JavaScript yourself. At the time of writing, using Web APIs (e.g. using &lt;code&gt;web-sys&lt;/code&gt; to manipulate the DOM) does require JavaScript, although this may not always be the case&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;. I haven&amp;rsquo;t explored the Yew path myself, so we&amp;rsquo;ll focus on the former path.&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;wasmbindgen&#34;&gt;&lt;code&gt;wasm-bindgen&lt;/code&gt; and &lt;code&gt;wasm-pack&lt;/code&gt;&lt;/h1&gt;
&lt;p&gt;&lt;code&gt;wasm-bindgen&lt;/code&gt; is a handy tool wherein you can simply add the &lt;code&gt;#[wasm_bindgen]&lt;/code&gt; attribute to structs and impl blocks to indicate that they should be exposed to JavaScript. For example, &lt;code&gt;SecureDropSourceSession&lt;/code&gt; below is a Rust struct I wanted to make available as a JavaScript class:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-Rust&#34; data-lang=&#34;Rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[wasm_bindgen]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;SecureDropSourceSession&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;store&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;InMemSignalProtocolStore&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registration_id&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;It encapsulates a private member &lt;code&gt;InMemSignalProtocolStore&lt;/code&gt; that methods in our impl block in Rust will use when performing crypto operations in our WebAssembly module.&lt;/p&gt;
&lt;p&gt;Now I can provide methods (to JavaScript) on this struct using an impl block also with the &lt;code&gt;#[wasm_bindgen]&lt;/code&gt; attribute&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-Rust&#34; data-lang=&#34;Rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[wasm_bindgen]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SecureDropSourceSession&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;Result&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SecureDropSourceSession&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;JsValue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;csprng&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;OsRng&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registration_id&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u32&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;csprng&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;gen&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;kd&#34;&gt;let&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;identity_key&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;IdentityKeyPair&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;generate&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;csprng&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;);&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;// This struct will hold our session, identity, prekey and sender key stores.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;c1&#34;&gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;InMemSignalProtocolStore&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;identity_key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registration_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;store&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;SecureDropSourceSession&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;store&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;                &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;registration_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;})&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map_err&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;().&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;into&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;The &lt;code&gt;Result&amp;lt;T, JsValue&amp;gt;&lt;/code&gt; return type is a common pattern that &lt;code&gt;wasm-bindgen&lt;/code&gt; will use to throw JavaScript exceptions when the &lt;code&gt;Err&lt;/code&gt; variant is returned.&lt;/p&gt;
&lt;p&gt;Once the WebAssembly module is compiled and loaded, I can now create &lt;code&gt;SecureDropSourceSession&lt;/code&gt; objects (now that I&amp;rsquo;ve implemented &lt;code&gt;SecureDropSourceSession::new&lt;/code&gt;) from JavaScript:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-JavaScript&#34; data-lang=&#34;JavaScript&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kd&#34;&gt;var&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;session&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nx&#34;&gt;SecureDropSourceSession&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;();&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;building&#34;&gt;Building&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;wasm-pack&lt;/code&gt; builds your project along with some autogenerated helper JS to a folder called &lt;code&gt;pkg&lt;/code&gt;. This is useful if you use a bundler like Webpack since you can simply add the path to your WebAssembly package to your dependencies. This is also useful if you want to publish your WebAssembly package to &lt;code&gt;npm&lt;/code&gt;. By publishing to &lt;code&gt;npm&lt;/code&gt;, folks using the package will not need the Rust toolchain installed since you&amp;rsquo;ll be publishing the built Wasm artifact.&lt;/p&gt;
&lt;p&gt;You can also &lt;a href=&#34;https://github.com/freedomofpress/securedrop-e2e#development&#34;&gt;go the route of not using a bundler&lt;/a&gt;, which you can read about in more detail &lt;a href=&#34;https://rustwasm.github.io/docs/wasm-bindgen/examples/without-a-bundler.html&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&#34;useful&#34;&gt;Useful crates&lt;/h1&gt;
&lt;p&gt;Other useful crates to know of are &lt;code&gt;js_sys&lt;/code&gt; and &lt;code&gt;web_sys&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;js_sys&lt;/code&gt; lets you call JavaScript functions from your Rust code, such as &lt;a href=&#34;https://docs.rs/js-sys/0.3.46/js_sys/fn.escape.html&#34;&gt;&lt;code&gt;escape()&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;web_sys&lt;/code&gt; provides Web APIs (through JavaScript). For example, you can manipulate the DOM or get access to the &lt;a href=&#34;https://docs.rs/web-sys/0.3.46/web_sys/struct.Window.html#impl-62&#34;&gt;WebCrypto API&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For debugging, there&amp;rsquo;s &lt;a href=&#34;https://github.com/rustwasm/console_error_panic_hook&#34;&gt;&lt;code&gt;console_error_panic_hook&lt;/code&gt;&lt;/a&gt;, which lets you &lt;a href=&#34;https://github.com/freedomofpress/securedrop-e2e/blob/main/securedrop-source/src/lib.rs#L40&#34;&gt;add a panic hook&lt;/a&gt; that passes panics through to the JavaScript console:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;panic&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;set_hook&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Box&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;console_error_panic_hook&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;hook&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;));&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h1 id=&#34;refs&#34;&gt;Referencecs&lt;/h1&gt;
&lt;p&gt;This post was a very brief overview. There are great tutorials out there on Rust and WebAssembly, and the main references I found useful while learning enough to implement my project are here:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://rustwasm.github.io/docs/book/&#34;&gt;Rust and WebAssembly book&lt;/a&gt; - an introduction to using Rust and WebAssembly together wherein you implement the Game of Life in the browser&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://developer.mozilla.org/en-US/docs/WebAssembly/Rust_to_wasm&#34;&gt;MDN&amp;rsquo;s intro to &lt;code&gt;wasm-bindgen&lt;/code&gt; and &lt;code&gt;wasm-pack&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.amazon.com/Programming-WebAssembly-Rust-Development-Applications/dp/1680506366&#34;&gt;Programming WebAssembly with Rust&lt;/a&gt; - a short read covering both WebAssembly in the browser as well as WASI (if you want to run WebAssembly independent of web browsers)&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://rustwasm.github.io/docs/wasm-bindgen/&#34;&gt;the &lt;code&gt;wasm-bindgen&lt;/code&gt; book&lt;/a&gt; - This is a nice reference text with the details of using &lt;code&gt;wasm-bindgen&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Happy hacking!&lt;/p&gt;
&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;
&lt;p&gt;See the &lt;a href=&#34;https://github.com/WebAssembly/interface-types/blob/master/proposals/interface-types/Explainer.md&#34;&gt;Interface Types explainer&lt;/a&gt;.&amp;#160;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:2&#34;&gt;
&lt;p&gt;Random number generation is using the &lt;a href=&#34;https://github.com/rust-random/getrandom/blob/master/src/wasm-bindgen.rs#L93&#34;&gt;WebCrypto API&amp;rsquo;s getRandomValues() method&lt;/a&gt; under the hood via the &lt;code&gt;rand&lt;/code&gt; and &lt;code&gt;getrandom&lt;/code&gt; crates.&amp;#160;&lt;a href=&#34;https://www.redshiftzero.com/post/webassembly/#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/rust/">Rust</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/rust/">Rust</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/webassembly/">WebAssembly</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Creating Python extensions in Rust using PyO3</title>
                <link>https://www.redshiftzero.com/post/pyo3/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/pyo3/</guid>
                <pubDate>Sun, 06 Dec 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;This post describes how I approached writing a Python extension in Rust. The post covers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/pyo3/#why&#34;&gt;why one would even want to do this 🙃&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/pyo3/#approaches&#34;&gt;the approaches for calling Rust code from Python&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/pyo3/#pyo3&#34;&gt;an overview of how to create a Python module in Rust using PyO3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/pyo3/#tricky&#34;&gt;some tricky parts, e.g. inheritance&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/pyo3/#building&#34;&gt;building and distributing wheels&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let&amp;rsquo;s get started.&lt;/p&gt;
&lt;h1 id=&#34;why&#34;&gt;First, why do this at all?&lt;/h1&gt;
&lt;p&gt;There are two main reasons:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;To use Rust libraries that already exist, e.g. cryptography libraries.&lt;/li&gt;
&lt;li&gt;To do computationally intensive work that will be too slow in Python. Other approaches if this is the main motivation are using a C extension (e.g. as &lt;a href=&#34;https://github.com/numpy/numpy&#34;&gt;numpy&lt;/a&gt; does) or using projects like Cython or numba.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;For my use case, I had the first reason, I wanted to prototype something using a Rust crate that implemented a cryptographic protocol.&lt;/p&gt;
&lt;h1 id=&#34;approaches&#34;&gt;Approaches&lt;/h1&gt;
&lt;p&gt;There are multiple approaches for calling compiled Rust code from Python, including &lt;a href=&#34;https://docs.python.org/3/library/ctypes.html&#34;&gt;&lt;code&gt;ctypes&lt;/code&gt;&lt;/a&gt;, &lt;code&gt;cffi&lt;/code&gt; and &lt;code&gt;PyO3&lt;/code&gt;. Here we&amp;rsquo;ll cover the two most popular: &lt;code&gt;cffi&lt;/code&gt; (considered easier to use than &lt;code&gt;ctypes&lt;/code&gt;) and &lt;code&gt;PyO3&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&#34;cffi&#34;&gt;cffi&lt;/h3&gt;
&lt;p&gt;You can use &lt;code&gt;extern&lt;/code&gt; keyword to allow other languages to call Rust functions.&lt;/p&gt;
&lt;p&gt;For example this &lt;code&gt;add&lt;/code&gt; function is marked as a public external function using the &lt;code&gt;pub extern&lt;/code&gt; keywords. The &lt;a href=&#34;https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#calling-rust-functions-from-other-languages&#34;&gt;&lt;code&gt;#[no_mangle]&lt;/code&gt; attribute&lt;/a&gt; just tells the compiler to preserve the readable function name.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[no_mangle]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;extern&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;One you compile the above, one can then use Python&amp;rsquo;s &lt;a href=&#34;https://cffi.readthedocs.io/en/latest/&#34;&gt;&lt;code&gt;cffi&lt;/code&gt;&lt;/a&gt; library to call the &lt;code&gt;add&lt;/code&gt; function. First one must build the library using the &lt;a href=&#34;https://doc.rust-lang.org/reference/linkage.html&#34;&gt;&lt;code&gt;cdylib&lt;/code&gt; crate type&lt;/a&gt; to produce a dynamic library.&lt;/p&gt;
&lt;p&gt;Then, one can load this dynamic library and call the external Rust functions:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;ffi&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cffi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;FFI&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;ffi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cdef&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;    int add(int, int);
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;adder&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ffi&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dlopen&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;location&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;assert&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adder&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;You can see this example in full on GitHub &lt;a href=&#34;https://github.com/redshiftzero/rust-python-examples#cffi&#34;&gt;here&lt;/a&gt;. Read more about Rust FFI &lt;a href=&#34;https://doc.rust-lang.org/nomicon/ffi.html&#34;&gt;here&lt;/a&gt; and if you do take the FFI path, you might want to check out the &lt;a href=&#34;https://github.com/getsentry/milksnake&#34;&gt;milksnake&lt;/a&gt; project for building and distributing wheels.&lt;/p&gt;
&lt;h3 id=&#34;pyo3&#34;&gt;PyO3&lt;/h3&gt;
&lt;p&gt;PyO3 is a very cool project that allows one to define a Python module entirely in Rust. The above example in PyO3 would be:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[pyfunction]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;kt&#34;&gt;i32&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;+&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;And to define the actual Python module:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[pymodule]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;adder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;Python&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;module&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PyModule&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;PyResult&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;add_wrapped&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;wrap_pyfunction&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;This means that now from the Python interpreter we can just do:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;adder&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;adder&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;add&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;As we can see, the PyO3 approach is very straightforward. You simply add attributes to structs and functions in Rust to indicate that they should be exposed to Python, and then you write a Rust function to indicate what the top-level functions and classes are for that module.&lt;/p&gt;
&lt;p&gt;There are also similarly easy-to-use build tools (via &lt;code&gt;setuptools-rust&lt;/code&gt; and &lt;code&gt;maturin&lt;/code&gt;) to handle the packaging and build process. You can see this example packaged using &lt;code&gt;setuptools-rust&lt;/code&gt; on GitHub &lt;a href=&#34;https://github.com/redshiftzero/rust-python-examples#pyo3_basic&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In the rest of this post, I&amp;rsquo;ll explain more about using PyO3.&lt;/p&gt;
&lt;h2 id=&#34;pyo3&#34;&gt;Creating Python Modules with PyO3&lt;/h2&gt;
&lt;p&gt;The most important attributes to know are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;#[pyclass]&lt;/code&gt;: to expose a Rust struct as a Python class&lt;/li&gt;
&lt;li&gt;&lt;code&gt;#[pyfunction]&lt;/code&gt;: to expose a Rust function as a Python function&lt;/li&gt;
&lt;li&gt;&lt;code&gt;#[pymethods]&lt;/code&gt;: to expose the methods defined in an &lt;code&gt;impl&lt;/code&gt; block of a struct with the &lt;code&gt;#[pyclass]&lt;/code&gt; attribute as methods on the corresponding Python class&lt;/li&gt;
&lt;li&gt;&lt;code&gt;#[pymodule]&lt;/code&gt;: to expose a collection of structs or functions as a Python module&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Using these attributes, PyO3 macros will do all the FFI work for you.&lt;/p&gt;
&lt;p&gt;Functions and methods exposed to Python must have return values that are either native Rust types (that can be converted to &lt;code&gt;PyObject&lt;/code&gt; via the &lt;a href=&#34;https://docs.rs/pyo3/0.12.4/pyo3/conversion/trait.ToPyObject.html&#34;&gt;&lt;code&gt;ToPyObject&lt;/code&gt; trait&lt;/a&gt;) or Python object types (e.g. &lt;code&gt;PyDict&lt;/code&gt; not &lt;code&gt;dict&lt;/code&gt;). See the list of conversions &lt;a href=&#34;https://pyo3.rs/master/conversions/tables.html#mapping-of-rust-types-to-python-types&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Functions that can fail should return &lt;code&gt;PyResult&lt;/code&gt;, which is a type alias for &lt;code&gt;Result&amp;lt;T, PyErr&amp;gt;&lt;/code&gt;. If the Err variant is returned, an exception will be raised on the Python side. Note that you can also create &lt;a href=&#34;https://pyo3.rs/master/exception.html&#34;&gt;custom exception types&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&#34;classes-and-methods&#34;&gt;Classes and methods&lt;/h3&gt;
&lt;p&gt;Let&amp;rsquo;s create an example class, using &lt;code&gt;#[pyclass]&lt;/code&gt; and &lt;code&gt;#[pymethods]&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[pyclass]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pyo3(get)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pyo3(get)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pymethods]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[new]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;feed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;The &lt;code&gt;#[new]&lt;/code&gt; attribute is used for your object constructor and initialization logic in Python (equivalent of Python &lt;code&gt;__new__()&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;In Python, you&amp;rsquo;d call &lt;code&gt;doris = Animal(&#39;Doris&#39;, 2, 0)&lt;/code&gt; to use this.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;#[pyo3(get)]&lt;/code&gt; attribute lets one read &lt;code&gt;doris.name&lt;/code&gt; as member attributes. If you want to set attributes also, you can use &lt;code&gt;#[pyo3(get, set)]&lt;/code&gt; (which could replace the &lt;code&gt;Animal::feed()&lt;/code&gt; method if we wanted to).&lt;/p&gt;
&lt;p&gt;We can add this class to a new module as follows:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[pymodule]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;adder&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;py&lt;/span&gt;: &lt;span class=&#34;nc&#34;&gt;Python&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;module&lt;/span&gt;: &lt;span class=&#34;kp&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;nc&#34;&gt;PyModule&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;PyResult&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;module&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;add_class&lt;/span&gt;::&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(())&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id=&#34;tricky&#34;&gt;Some trickier parts of PyO3&lt;/h2&gt;
&lt;p&gt;The above parts can cover simple projects. Two more advanced topics we&amp;rsquo;ll cover are inheritance, and magic methods.&lt;/p&gt;
&lt;h3 id=&#34;inheritance&#34;&gt;Inheritance&lt;/h3&gt;
&lt;p&gt;What if we want to make a subclasses, say, a &lt;code&gt;Lion&lt;/code&gt;, that inherits from &lt;code&gt;Animal&lt;/code&gt;? Here&amp;rsquo;s how we do it:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;33
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;34
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;35
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;36
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;37
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;38
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[pyclass(subclass)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pyo3(get)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pyo3(get)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pymethods]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[new]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;feed&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;mut&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pyclass(extends=Animal)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;pub&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;struct&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Lion&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pyo3(get)]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;favorite_meat&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[pymethods]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Lion&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;#[new]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;: &lt;span class=&#34;kt&#34;&gt;u8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;favorite_meat&lt;/span&gt;: &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;PyResult&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;Self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Lion&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;favorite_meat&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;},&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;age&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;hours_since_last_fed&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;roar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;ROAR!!!!&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_string&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;The &lt;code&gt;#[pyclass]&lt;/code&gt; annotations indicate the parent (&lt;code&gt;#[pyclass(subclass)]&lt;/code&gt;) and child (&lt;code&gt;#[pyclass(extends=Parent)]&lt;/code&gt;) classes. The tuple syntax in the return value of the child is a little &amp;ldquo;trick&amp;rdquo; intended for ergonomics: you return &lt;code&gt;PyResult&amp;lt;(Child, Parent)&amp;gt;&lt;/code&gt; or &lt;code&gt;(Child, Parent)&lt;/code&gt;. PyO3 will then run &lt;code&gt;Into&amp;lt;PyClassInitializer&amp;gt;&lt;/code&gt; on the child, where &lt;a href=&#34;https://docs.rs/pyo3/0.12.4/pyo3/pyclass_init/struct.PyClassInitializer.html&#34;&gt;PyClassInitializer&lt;/a&gt; is PyO3&amp;rsquo;s pyclass initializer.&lt;/p&gt;
&lt;h3 id=&#34;magic-methods&#34;&gt;Magic methods&lt;/h3&gt;
&lt;p&gt;One might be surprised to find that implementing magic methods doesn&amp;rsquo;t work in a &lt;code&gt;#[pymethods]&lt;/code&gt; impl block. It turns out that you can implement Python &amp;ldquo;magic&amp;rdquo; methods like &lt;code&gt;__repr__&lt;/code&gt; and &lt;code&gt;__richcmp__&lt;/code&gt; using the &lt;code&gt;PyObjectProtocol&lt;/code&gt; trait and the &lt;code&gt;#[pyproto]&lt;/code&gt; attribute in a separate &lt;code&gt;impl&lt;/code&gt; block. For example, to add a nice string representation for &lt;code&gt;Animal&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;9
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-rust&#34; data-lang=&#34;rust&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;cp&#34;&gt;#[pyproto]&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;k&#34;&gt;impl&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PyObjectProtocol&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Animal&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;k&#34;&gt;fn&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;__str__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;-&amp;gt; &lt;span class=&#34;nc&#34;&gt;PyResult&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Ok&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;String&lt;/span&gt;::&lt;span class=&#34;n&#34;&gt;from&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;fm&#34;&gt;format!&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;s&#34;&gt;&amp;#34;Animal: {}&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;            &lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;        &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)))&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;See some additional examples &lt;a href=&#34;https://github.com/freedomofpress/signal-protocol/blob/0c9c5d76e1876fa2be311430943ca8a3e3ae1f19/src/fingerprint.rs#L52-L61&#34;&gt;here&lt;/a&gt; and &lt;a href=&#34;https://github.com/freedomofpress/signal-protocol/blob/0c9c5d76e1876fa2be311430943ca8a3e3ae1f19/src/curve.rs#L124-L133&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;building&#34;&gt;Distributing wheels&lt;/h2&gt;
&lt;p&gt;We want to build and distribute wheels that do not require the rust toolchain to be installed on target systems. Fortunately, with &lt;code&gt;setuptools-rust&lt;/code&gt; and &lt;code&gt;maturin&lt;/code&gt;, that&amp;rsquo;s pretty simple. For &lt;code&gt;setuptools-rust&lt;/code&gt; our &lt;code&gt;setup.py&lt;/code&gt; for the &lt;code&gt;zoo&lt;/code&gt; example would be:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;sys&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;setuptools&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;setup&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;setuptools_rust&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Binding&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;RustExtension&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;setup&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;zoo&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;version&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;0.0.1&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;classifiers&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;s2&#34;&gt;&amp;#34;License :: OSI Approved :: GNU Affero General Public License v3 or later (AGPLv3+)&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;s2&#34;&gt;&amp;#34;Development Status :: 3 - Alpha&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;s2&#34;&gt;&amp;#34;Intended Audience :: Developers&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;s2&#34;&gt;&amp;#34;Programming Language :: Python&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;s2&#34;&gt;&amp;#34;Programming Language :: Rust&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;packages&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;zoo&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;rust_extensions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;RustExtension&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;zoo.zoo&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;Cargo.toml&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;binding&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Binding&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PyO3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;setup_requires&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;setuptools-rust&amp;gt;=0.10.1&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;wheel&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;],&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;zip_safe&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;False&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;  &lt;span class=&#34;c1&#34;&gt;# Rust extensions are not zip safe&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;See the full project &lt;a href=&#34;https://github.com/redshiftzero/rust-python-examples#pyo3_inherit&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Locally, if we&amp;rsquo;re on macOS, to build macOS wheels:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;python3 setup.py sdist bdist_wheel
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;To build manylinux wheels we can follow &lt;a href=&#34;https://github.com/PyO3/setuptools-rust#binary-wheels-on-linux&#34;&gt;the procedure described in the setuptools-rust project&lt;/a&gt;. First we fetch the Python Packaging Authority manylinux image:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;docker pull quay.io/pypa/manylinux2014_x86_64
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then using the default &lt;code&gt;build-wheels.sh&lt;/code&gt; script provided by &lt;code&gt;setuptools-rust&lt;/code&gt;:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;docker run --rm -v `pwd`:/io quay.io/pypa/manylinux2014_x86_64 /io/build-wheels.sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This leaves us with built wheels in &lt;code&gt;dist/&lt;/code&gt; ready for upload to PyPI. And we should just upload the manylinux wheels built by the script as PyPI does not support wheels with platform tags like &lt;code&gt;linux_x86_64&lt;/code&gt; (these are also produced by the above wheel build command but can be discarded).&lt;/p&gt;
&lt;h1 id=&#34;fin&#34;&gt;Fin&lt;/h1&gt;
&lt;p&gt;I hope you&amp;rsquo;re convinced that writing Rust extensions with PyO3 is approachable. To read more check out the &lt;a href=&#34;https://pyo3.rs/&#34;&gt;PyO3 guide&lt;/a&gt;. If you want to see a larger example, you can check out the library I wrote using PyO3 &lt;a href=&#34;https://github.com/freedomofpress/signal-protocol&#34;&gt;here&lt;/a&gt; and install in Python 3.7+, via &lt;code&gt;pip install signal-protocol&lt;/code&gt; 😊 .&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/rust/">Rust</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/rust/">Rust</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/pyo3/">pyo3</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Continuous threat modeling, Part 1: Tooling wish list</title>
                <link>https://www.redshiftzero.com/post/continuous-threat-modeling/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/continuous-threat-modeling/</guid>
                <pubDate>Tue, 10 Nov 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;h1 id=&#34;motivation&#34;&gt;Motivation&lt;/h1&gt;
&lt;p&gt;When performing software-centric threat-modeling on an application&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/continuous-threat-modeling/#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;, one typically:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;generates at least one Data Flow Diagram (DFD) or other diagrams that model the software,&lt;/li&gt;
&lt;li&gt;enumerates threats using the diagram(s) as an aid, and then&lt;/li&gt;
&lt;li&gt;determines which mitigations should be applied.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Automated tools can potentially aid the threat modeler in each of these stages. When the design of a system is modified, the threat modeling exercise may be performed again, resulting in needing to pass through the above steps again. Even if a design remains static, the threats and mitigations should still be evaluated periodically as the threat landscape may evolve, e.g. if attacker capabilities or motivations change. This means that tools or processes that can aid the threat modeler perform these tasks on a continuous basis can be of great value.&lt;/p&gt;
&lt;h1 id=&#34;tooling-to-aid-these-steps&#34;&gt;Tooling to aid these steps&lt;/h1&gt;
&lt;p&gt;When going about the above steps, several questions immediately come up, some of which have existing solutions in the ecosystem, and some of which do not.&lt;/p&gt;
&lt;h3 id=&#34;how-to-generate-and-store-the-diagrams&#34;&gt;How to generate and store the diagrams?&lt;/h3&gt;
&lt;p&gt;For an initial iteration, taking a picture of a sketch or whiteboard drawing can be sufficient. On an continuous basis having the DFD elements and data flows stored in a version-controllable format like XML (as &lt;a href=&#34;http://draw.io/&#34;&gt;draw.io&lt;/a&gt; does), YAML (as &lt;a href=&#34;https://github.com/Threagile/threagile&#34;&gt;threagile&lt;/a&gt; or &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling&#34;&gt;threat-modeling&lt;/a&gt; does) or directly as code (as &lt;a href=&#34;https://github.com/izar/pytm&#34;&gt;pytm&lt;/a&gt; does) is ideal. All of these tools enable one to generate the data flow diagrams from the version controlled DFD data.&lt;/p&gt;
&lt;p&gt;Some tools like &lt;a href=&#34;https://owasp.org/www-project-threat-dragon/&#34;&gt;OWASP Threat Dragon&lt;/a&gt;, &lt;a href=&#34;https://docs.microsoft.com/en-us/azure/security/develop/threat-modeling-tool&#34;&gt;Microsoft&amp;rsquo;s TMT&lt;/a&gt; and draw.io also provide a GUI to aid in this step.&lt;/p&gt;
&lt;h3 id=&#34;how-to-enumerate-and-store-threats&#34;&gt;How to enumerate and store threats?&lt;/h3&gt;
&lt;p&gt;Some of the above mentioned tools provide assistance for the threat enumeration process, using an existing methodology like STRIDE-per-element (in the case of Microsoft TMT and Threat Dragon), although these can only be used as an aid and need to be critically evaluated by the threat modeler to determine their relevance, and to add other potentially relevant threats. The threat modeling may also use existing attack libraries (like &lt;a href=&#34;https://capec.mitre.org/&#34;&gt;MITRE CAPEC&lt;/a&gt;) to aid in threat enumeration.&lt;/p&gt;
&lt;p&gt;In terms of storing the threats once enumerated, a first-order approach is to use an existing ticketing system (e.g. a private GitHub repository) or a spreadsheet to store enumerated threats.&lt;/p&gt;
&lt;p&gt;The advantage of a ticketing system is that it&amp;rsquo;s easy to crosslink with mitigations or individual development tickets being implemented. The downside is that it&amp;rsquo;s not easy (as it is with a spreadsheet) to e.g. sort all threats by risk score, which you might do in order to determine which are the most important threats on which to focus your engineering effort.&lt;/p&gt;
&lt;p&gt;The downside of the spreadsheet approach is that it&amp;rsquo;s a bit awkward to perform deeper analysis on, as well as follow one-to-many relationships. But, the spreadsheet has the advantage of being something that one can export as CSV and store in version control (although not in the most readable format, but one could then load the CSV in e.g. &lt;a href=&#34;https://pandas.pydata.org/&#34;&gt;pandas&lt;/a&gt; if one wants to perform further analysis).&lt;/p&gt;
&lt;p&gt;Some tools like &lt;a href=&#34;https://github.com/Threagile/threagile&#34;&gt;threagile&lt;/a&gt;, &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling&#34;&gt;threat-modeling&lt;/a&gt;, and &lt;a href=&#34;https://github.com/izar/pytm&#34;&gt;pytm&lt;/a&gt; store the enumerated threats in YAML, JSON, and in the case of pytm, a SQL dump. These all enable easy analysis using other tools as well as for YAML and JSON human-readable storage in version control.&lt;/p&gt;
&lt;h3 id=&#34;how-to-determine-which-mitigations-to-apply&#34;&gt;How to determine which mitigations to apply?&lt;/h3&gt;
&lt;p&gt;Once threats have been enumerated, next we need to decide how to make decisions about them. If we can mitigate all threats, then great. However, we might be unable to completely mitigate all threats, so we need to decide how to allocate the engineering effort we have in a rational manner to manage the risk. There are not a lot of tools that aid in this dimension (see the next section on Simulation-like question answering).&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Edit 11/12/2020&lt;/em&gt;: Another important aspect here is how best to store the mitigations - and their mapping to threats. It is highly useful to track which mitigations map to which threats such that developers can clearly see the purpose of the mitigation, and to enable one to evaluate the impact of removing a given security control (e.g. if debates arise on their importance due to maintenance burden or user impact). In &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling&#34;&gt;threat-modeling&lt;/a&gt;, the approach is to store the mitigations also in YAML, similar to the threats, with references to the threat IDs they apply to, to enable this sort of analysis&lt;sup id=&#34;fnref:2&#34;&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/continuous-threat-modeling/#fn:2&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h1 id=&#34;ideas&#34;&gt;Ideas&lt;/h1&gt;
&lt;p&gt;Next, here are some directions that I think would be useful to explore further.&lt;/p&gt;
&lt;h3 id=&#34;integration-in-cicd-pipelines&#34;&gt;Integration in CI/CD pipelines&lt;/h3&gt;
&lt;p&gt;The &lt;a href=&#34;https://github.com/threatspec/threatspec&#34;&gt;threatspec folks&lt;/a&gt; suggest integrating their tool (which is quite cool and involves adding annotations directly in the application code) as part of a CI/CD pipeline performing report or DFD generation.&lt;/p&gt;
&lt;p&gt;One could also imagine deeper integration in CI/CD pipelines. For example, by parsing the DFD, threats, and mitigations data, in CI one could flag issues like:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Dataflow has no threats enumerated for it (i.e. threats are missing)&lt;/li&gt;
&lt;li&gt;Threats have no status (i.e. a decision needs to be made to accept, transfer, mitigate, etc.)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Or inconsistencies in the DFD data itself to guide system modelers, e.g.:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;No trust boundaries present (there should be at least one trust boundary)&lt;/li&gt;
&lt;li&gt;Process element lacks entry or exit dataflow (there should be an entry and an exit)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling#linter&#34;&gt;explored&lt;/a&gt; in the &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling&#34;&gt;threat-modeling&lt;/a&gt; tool (&lt;a href=&#34;https://github.com/freedomofpress/threat-modeling/issues/52&#34;&gt;ticket&lt;/a&gt;).&lt;/p&gt;
&lt;h3 id=&#34;simulation-like-question-answering&#34;&gt;Simulation-like question answering&lt;/h3&gt;
&lt;p&gt;As a system designer we often ask questions like (see ticket &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling/issues/49&#34;&gt;here&lt;/a&gt;):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;What happens if I remove mitigation X? How much does total risk increase?&lt;/li&gt;
&lt;li&gt;I only have time to implement one complex mitigation, is it rational to implement mitigation X or mitigation Y?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A tool that can aid in answering these questions (in a lightweight fashion), e.g. by recomputing the total risk score when a mitigation is removed or added, could be very helpful in decision-making. Of course a pre-requisite here is the accuracy of the risk scores - if they are very uncertain, that may need to be factored into the analysis (e.g. as is done in &lt;a href=&#34;https://www.fairinstitute.org/&#34;&gt;FAIR (Factor Analysis of Information Risk) risk framework&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;The only tool I&amp;rsquo;m aware of in this direction is &lt;a href=&#34;https://distrinet.cs.kuleuven.be/software/sparta/#&#34;&gt;the SPARTA tool&lt;/a&gt; from KU Leuven which allows one to both rank risks as well as answer some simulation-type questions using an approach based on the FAIR risk framework.&lt;/p&gt;
&lt;h3 id=&#34;attack-tree-or-attack-graph-generation&#34;&gt;Attack tree (or attack graph) generation&lt;/h3&gt;
&lt;p&gt;While the exercise of generating attack trees manually is a useful one for system designers (as is threat enumeration), one could also imagine at least partially automating the generation of attack trees.&lt;/p&gt;
&lt;p&gt;When an attacker is able to successfully realize a given threat as an attack, other threats become accessible, e.g. once one is able to get code execution in a VM, they can next attempt to exploit a bug in the hypervisor. One could annotate threats with these child-parent relationships to indicate which threats become accessible once the given threat is realized, and from that derive attack trees. This is the approach taken &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling/blob/main/threat_modeling/threats.py#L185-L213&#34;&gt;here&lt;/a&gt; in the &lt;a href=&#34;https://github.com/freedomofpress/threat-modeling&#34;&gt;threat-modeling&lt;/a&gt; tool&lt;sup id=&#34;fnref:3&#34;&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/continuous-threat-modeling/#fn:3&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;3&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;h1 id=&#34;fin&#34;&gt;Fin&lt;/h1&gt;
&lt;p&gt;If you have thoughts on this or know of tools or approaches (especially if FLOSS 😇) that address the above concerns, feel free to drop me a note on &lt;a href=&#34;https://twitter.com/redshiftzero&#34;&gt;Twitter&lt;/a&gt; or by &lt;a href=&#34;mailto:jen@redshiftzero.com&#34;&gt;email&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;
&lt;p&gt;A lot has already been written on the benefits of doing threat modeling so I&amp;rsquo;m not going to espouse the benefits here.&amp;#160;&lt;a href=&#34;https://www.redshiftzero.com/post/continuous-threat-modeling/#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:2&#34;&gt;
&lt;p&gt;Armed with this mitigations data, one could do a &amp;ldquo;resilience&amp;rdquo; sort of test here, where one could simulate the impact of the failure of a given countermeasure: pick a given countermeasure, disable it, what is the impact of disabling this mitigation? If it&amp;rsquo;s significant, then this shows an area where one should focus additional effort to provide defense in depth.&amp;#160;&lt;a href=&#34;https://www.redshiftzero.com/post/continuous-threat-modeling/#fnref:2&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id=&#34;fn:3&#34;&gt;
&lt;p&gt;One could also imagine various ways of removing the parent-child threat annotation requirement, e.g. perhaps one could have the system designer specify the likely entry-point threats on the attack surface of the system. At this point provided there is a mapping of threats to DFD elements, the rest of the process could be automated: the entry-point threats are root nodes, and then one follows the dataflows to grow the rest of the attack tree, adding a child node in the attack tree for every threat associated with the destination node.&amp;#160;&lt;a href=&#34;https://www.redshiftzero.com/post/continuous-threat-modeling/#fnref:3&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/threat-modeling/">threat modeling</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/security/">security</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/threat-modeling/">threat modeling</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Investigating the Signal Protocol, Part 3: Web applications</title>
                <link>https://www.redshiftzero.com/post/signal-webapps/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/signal-webapps/</guid>
                <pubDate>Thu, 22 Oct 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Next in the series, I investigate current messaging applications that both provide web applications and are using the Signal Protocol (or a protocol very similar or derived from Signal), here specifically Wire and Whatsapp. I&amp;rsquo;m not looking into the voice and video aspects, just the messaging and file sharing capabilities as I&amp;rsquo;m investigating to see how a similar approach could be used for SecureDrop, where voice/video isn&amp;rsquo;t an option. As always, if you have thoughts on this or notice errors, feel free to drop me a note on &lt;a href=&#34;https://twitter.com/redshiftzero&#34;&gt;Twitter&lt;/a&gt; or by &lt;a href=&#34;mailto:jen@redshiftzero.com&#34;&gt;email&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&#34;end-to-end-over-the-web&#34;&gt;End-to-end over the web&lt;/h1&gt;
&lt;p&gt;A &lt;a href=&#34;https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2011/august/javascript-cryptography-considered-harmful/&#34;&gt;lot&lt;/a&gt; &lt;a href=&#34;https://community.signalusers.org/t/web-app-for-signal/1272/&#34;&gt;has been&lt;/a&gt; &lt;a href=&#34;https://www.zfnd.org/blog/so-you-want-an-e2e-encrypted-webapp/&#34;&gt;written&lt;/a&gt; already on the significant challenges using a web browser for e2e crypto.&lt;/p&gt;
&lt;p&gt;The main issue is that when you use an e2e webapp, the webserver you&amp;rsquo;re connected to is serving the cryptographic code to you. This means a malicious server can tamper with any of the code served to you and can, for example, display &amp;ldquo;verified fingerprints&amp;rdquo; in the webapp while an active man-in-the-middle is taking place.&lt;/p&gt;
&lt;p&gt;Compare this with developer-signed desktop applications, where you can ensure that code from the developer you trust is what is running. In the desktop application case, if the server you&amp;rsquo;re connected to is malicious they can&amp;rsquo;t replace the code running on your desktop.&lt;/p&gt;
&lt;p&gt;But for e2e webapps, you&amp;rsquo;re trusting the server - and the integrity of the data flow between your browser and the server.&lt;/p&gt;
&lt;p&gt;Another challenge is you need to decide where to store the key material. One could put it in browser storage, but what happens if a user changes browsers? Do you generate new keys each time a user uses a new browser? Or do you put the key material somewhere else on the user&amp;rsquo;s machine? At least for Wire, they do generate new keys when you use a new browser, which we&amp;rsquo;ll see more below.&lt;/p&gt;
&lt;h1 id=&#34;wire&#34;&gt;Wire&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;The below information is from reading the &lt;a href=&#34;https://wire-docs.wire.com/download/Wire+Security+Whitepaper.pdf&#34;&gt;Wire Whitepaper&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Wire has apps for mobile (Android, iOS), desktop (macOS, Windows, Linux), as well as an end-to-end encrypted web application.&lt;/p&gt;
&lt;h3 id=&#34;user-and-client-registration&#34;&gt;User and client registration&lt;/h3&gt;
&lt;p&gt;First, users must have a Wire account to use the service. User registration can be done via:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;email, where the user must validate a random verification code sent via email (to prove ownership of the account); these must be verified in three attempts,&lt;/li&gt;
&lt;li&gt;phone, where the user must validate a verification code sent via SMS, this code must also be verified in three attempts,&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;User registration gets the user their Wire internal ID (UUID v4) and an authentication cookie (used to authenticate to the Wire API).&lt;/p&gt;
&lt;p&gt;Next, users can register clients in order to start sending/receiving e2e messages. Wire allows a single temporary client and up to 7 permanent devices. During client registration, the client generates a Curve25519 long-term identity keypair and sends:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;what type it is (either Permanent or Temporary),&lt;/li&gt;
&lt;li&gt;the public Curve25519 identity key&lt;/li&gt;
&lt;li&gt;65,535 one-time use Curve25519 prekeys (see Blog post 1 on X3DH for how that works), which clients periodically replenish, and&lt;/li&gt;
&lt;li&gt;the &amp;ldquo;last resort&amp;rdquo; (lr) prekey, which is similar to the signed prekey in X3DH, in that it&amp;rsquo;s used if all other prekeys are exhausted. The Wire whitepaper makes no mention of signing this prekey though.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;encryption&#34;&gt;Encryption&lt;/h3&gt;
&lt;p&gt;The primitives Wire uses are ChaCha20, HMAC-SHA256, and Curve25519, with HKDF for key derivation.&lt;/p&gt;
&lt;p&gt;Senders encrypt a message to all members of a group (&amp;ldquo;conversation&amp;rdquo; in Wire) for every participant and send in a batch to the server. If the sender did not include messages for all participants, the server rejects the batch. Clients keep track of which participants are in a conversation, and learn from the server when they need to update. This is more similiar to how Sesame works in Signal, compared to Signal groups v1, as the server is keeping track of group participants, which clients update to.&lt;/p&gt;
&lt;p&gt;For large file attachments, senders generate a symmetric key and encrypt the file using AES-CBC-256 with PKCS#5 padding. The key and SHA-256 of the ciphertext are then encrypted for each participant. The servers gets just one copy of the encrypted file and a message as usual for each participant. This means that clients do not need to upload the same potentially large file many times encrypted to different participants. According to the whitepaper, these assets are stored basically indefinitely (as opposed to when all clients have downloaded the attachment).&lt;/p&gt;
&lt;h3 id=&#34;fingerprint-verification&#34;&gt;Fingerprint Verification&lt;/h3&gt;
&lt;p&gt;Users can compare fingerprints, and if all clients in a conversation are verified, this in indicated in the UI with a blue shield.&lt;/p&gt;
&lt;h3 id=&#34;web-client&#34;&gt;Web Client&lt;/h3&gt;
&lt;p&gt;New &amp;ldquo;devices&amp;rdquo; (i.e. new browsers) generate new device keys, the private key material of which is stored using &lt;a href=&#34;https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API&#34;&gt;IndexedDB&lt;/a&gt;. Messages are also stored only locally once fetched from the server, which is why conversation history does not appear when you sign in using a new device.&lt;/p&gt;
&lt;p&gt;The use of IndexedDB is why Wire does not work in Tor Browser - IndexedDB does not work in PBM (Private Browsing Mode) (&lt;a href=&#34;https://gitlab.torproject.org/tpo/applications/tor-browser/-/issues/26463&#34;&gt;Tor ticket&lt;/a&gt;, &lt;a href=&#34;https://bugzilla.mozilla.org/show_bug.cgi?id=781982&#34;&gt;Firefox ticket 1&lt;/a&gt;). This makes sense since IndexedDB adheres to a same-origin policy and as such stores data associated with the origin, so allowing this storage in PBM would present privacy issues. However, there are some &lt;a href=&#34;https://bugzilla.mozilla.org/show_bug.cgi?id=1562669&#34;&gt;proposals&lt;/a&gt; on the Mozilla side to resolve this and thus enable IndexedDB storage in PBM, so this is an area to monitor.&lt;/p&gt;
&lt;h1 id=&#34;whatsapp&#34;&gt;WhatsApp&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;The below information is from reading the &lt;a href=&#34;https://scontent.whatsapp.net/v/t39.8562-34/89275998_627986927772871_4167828889579552768_n.pdf?_nc_sid=2fbf2a&amp;amp;_nc_ohc=CZmsR-aJVosAX8yXnbf&amp;amp;_nc_ht=scontent.whatsapp.net&amp;amp;oh=c06ea21064d8cab63370372bdd20296b&amp;amp;oe=5F9C2FD1&#34;&gt;WhatsApp Security Whitepaper&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;WhatsApp provides clients for mobile (Android, iOS), desktop (macOS, Windows), as well as a web client via WhatsApp Web. I couldn&amp;rsquo;t really find too much detail about how the web client was approached from a security standpoint, but the below information should apply to all clients.&lt;/p&gt;
&lt;h3 id=&#34;user-and-client-registration-1&#34;&gt;User and client registration&lt;/h3&gt;
&lt;p&gt;During client registration, the process works as one would expect from reading the &lt;a href=&#34;https://signal.org/docs/specifications/x3dh/&#34;&gt;X3DH specification&lt;/a&gt;: clients generate a long-term identity key, a signed prekey, and one-time pre-keys. The client then sends the public parts of all the above keys along with the signature of (signed) prekey to the WhatsApp server.&lt;/p&gt;
&lt;p&gt;Clients authenticate to servers using their long-term keypair, so there are no user credentials on the server to compromise.&lt;/p&gt;
&lt;h3 id=&#34;encryption-1&#34;&gt;Encryption&lt;/h3&gt;
&lt;p&gt;To establish sessions, the initiator computes a shared key ($SK$ in the &lt;a href=&#34;https://signal.org/docs/specifications/x3dh/&#34;&gt;X3DH specification&lt;/a&gt;), which the receiver also constructs on receipt of the initiating message. They both use HKDF to derive an initial root key and chain key to initialize session state. From that point clients can encrypt and decrypt messages by deriving each individual message key from chain keys, ratcheting chain keys forward, and updating root keys using updated shared secrets. This is all performed as described in the &lt;a href=&#34;https://signal.org/docs/specifications/doubleratchet&#34;&gt;double ratchet specification&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For large attachments, WhatsApp has a similar blob store as Wire. They have senders generate an ephemeral 32-byte AES encryption key (for AES-CBC with random IV) and an ephemeral 32-byte MAC key (for HMAC-SHA256). They encrypt-then-MAC and upload the attachment. The message to the recipient then just contains the AES key, the IV, the MAC key, a SHA256 hash, and a reference to the location in the blob store. Recipients must download, decrypt, and verify the hash and MAC prior to decryption. As above, this prevents clients from having to encrypt and send the same large file to multiple participants.&lt;/p&gt;
&lt;p&gt;In terms of groups, WhatsApp uses a method that requires servers have knowledge of group participants. This is because Whatsapp uses a &amp;ldquo;server-side fan out&amp;rdquo;, wherein a message to N clients is just sent once by the client, then forwarded on to the N clients by the server. The disadvantage here is that the server must know which N participants should receive the message. The advantage is that one could have larger groups than if you require a client-side fan out, wherein all clients send each message to all N participants in a group.&lt;/p&gt;
&lt;p&gt;In more detail, WhatsApp has clients generate a random &lt;em&gt;Chain key&lt;/em&gt; and random Curve25519 key pair they call the &lt;em&gt;Signature key&lt;/em&gt; upon joining a group. These two keys are described as a &lt;em&gt;Sender key&lt;/em&gt;, and are sent to all group participants pairwise. Each chain key is used by participants to derive individual message keys. Ciphertexts are signed by senders using the signature key. When a group participant sends a message, the server performs the server-side fan out, sending the ciphertext to all other group participants. The receiving group participants can decrypt the ciphertext since they received the chain key from the sender previously. The sender keys are rotated whenever a group member leaves. One hiccup here is that as described, the DH ratchet is not happening: if a chain key is compromised, all other messages using message keys dervied from that chain key can be decrypted. This will be the case until a group member leaves.&lt;/p&gt;
&lt;p&gt;One other interesting note from the whitepaper is that client-server connections are also encrypted at the transport-level using &lt;a href=&#34;https://noiseprotocol.org/&#34;&gt;Noise Pipes&lt;/a&gt; (they used Curve25519, AES-GCM, SHA256).&lt;/p&gt;
&lt;h3 id=&#34;fingerprint-verification-1&#34;&gt;Fingerprint Verification&lt;/h3&gt;
&lt;p&gt;Fingerprints are in the form of QR codes or 60-digit fingerprints (30 digits per party). These codes are derived from the public part of the long-term identity key for both parties, along with for the QR code, a version and user identifiers for each party.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/signal/">Signal</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/signal/">Signal</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/security/">security</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/protocol/">protocol</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Investigating the Signal Protocol, Part 2: Groups, devices</title>
                <link>https://www.redshiftzero.com/post/signal-group-multidevice/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/signal-group-multidevice/</guid>
                <pubDate>Wed, 14 Oct 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Next in the series, I investigate how groups and multi-device support are handled. If you have thoughts on this or notice any errors, feel free to drop me a note on &lt;a href=&#34;https://twitter.com/redshiftzero&#34;&gt;Twitter&lt;/a&gt; or by &lt;a href=&#34;mailto:jen@redshiftzero.com&#34;&gt;email&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id=&#34;groups&#34;&gt;Groups&lt;/h1&gt;
&lt;p&gt;Signal allows &lt;a href=&#34;https://signal.org/blog/private-groups/&#34;&gt;private groups&lt;/a&gt; where the server doesn&amp;rsquo;t have access to the group metadata, including the list of members in each group. Servers cannot even distinguish group from direct messages.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s say a group contains two users, Alice👧🏼 and Bob👦🏽, and a third user Jen🧙 wants to send the group a message. Alice👧🏼 adds Jen🧙 to the group, and then Jen🧙 can send the group a message by sending messages individually to each user in the group: she encrypts her message $M$ to each group participant separately, encrypting using the next message key she has for Alice👧🏼 and Bob👦🏽. One caveat is that she uses separate ratchet state than her direct chats with Alice👧🏼 and Bob👦🏽.&lt;/p&gt;
&lt;p&gt;Group management messages are regular Signal (i.e. e2e encrypted) messages that only clients can decrypt and act on. The advantage of this approach is that the server stores nothing about groups, although the server can of course infer group participants through observing the timing and metadata of messages, but we&amp;rsquo;ll put that aside for now.&lt;/p&gt;
&lt;p&gt;For example, if Alice👧🏼 chooses to leave a group:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Alice👧🏼 sends a leave group management message to all other group members (along with the ID of the group).&lt;/li&gt;
&lt;li&gt;Clients process this and remove Alice👧🏼 from their locally stored list of users in that group.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Similarly for other group information update tasks, any group participant can send a group management message adding (but not deleting) new users or updating the group information. This means that since users must remove &lt;em&gt;themselves&lt;/em&gt; from groups using a leave message, if a group wants to remove a given user and the user does not leave, effectively users must create a new group without the participant they want to remove.&lt;/p&gt;
&lt;p&gt;The group system is under active development, see the preview version of the group management using anonymous credentials described &lt;a href=&#34;https://signal.org/blog/signal-private-group-system/&#34;&gt;here&lt;/a&gt;. Note also that Whatsapp appears to handle groups differently from the Signal application.&lt;/p&gt;
&lt;h1 id=&#34;multi-device&#34;&gt;Multi-device&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;The full description is covered in &lt;a href=&#34;https://signal.org/docs/specifications/sesame/&#34;&gt;this specification&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;For multi-device support, the main concepts we need to know about are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Users, which are identified by &lt;code&gt;UserID&lt;/code&gt; and can have one or more devices.&lt;/li&gt;
&lt;li&gt;Devices, which are identified by &lt;code&gt;DeviceID&lt;/code&gt;. Each device has its own keypair.&lt;/li&gt;
&lt;li&gt;Sessions, which are identified by &lt;code&gt;SessionID&lt;/code&gt;. This is the ratchet state that can be used for processing incoming and outgoing messages.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The server keeps track of the mapping of users (&lt;code&gt;UserID&lt;/code&gt;) to devices (&lt;code&gt;DeviceID&lt;/code&gt;). This is different than with groups, where the server doesn&amp;rsquo;t need to keep track of users in groups.&lt;/p&gt;
&lt;p&gt;An &lt;em&gt;initiation message&lt;/em&gt; begins a session. In this message, the sender includes their device public key, so the recipient knows which of the user&amp;rsquo;s devices is active. Clients keep track locally of a mapping of users (&lt;code&gt;UserID&lt;/code&gt;) to devices (&lt;code&gt;DeviceID&lt;/code&gt;) and furthermore, which of the devices is active.&lt;/p&gt;
&lt;p&gt;When Bob👦🏽 sends Alice👧🏼 a message $m$, he encrypts $m$ for all of Alice👧🏼&amp;rsquo;s devices using active sessions if available. This is the first batch of messages. Bob👦🏽 does the same action for himself: he encrypts the message $m$ to all of his own devices (a second batch of messages). For each batch he:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Sends the batch of messages to the server.&lt;/li&gt;
&lt;li&gt;If Bob👦🏽&amp;rsquo;s local view of the receiver device state was stale, the server rejects the messages and lets Bob👦🏽 know to update. Else, the servers puts the messages in the message delivery queues for those devices.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;By doing this Bob👦🏽&amp;rsquo;s other devices will also have the message history of this conversation even if the device is not active.&lt;/p&gt;
&lt;p&gt;When Alice👧🏼 connects to the server to get her messages, she uses any initiation messages to update her local store of device and session state. Otherwise, she uses the existing session state as usual to process the message.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/signal/">Signal</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/signal/">Signal</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/security/">security</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/protocol/">protocol</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Investigating the Signal Protocol, Part 1: Foundations</title>
                <link>https://www.redshiftzero.com/post/signal-protocol/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/signal-protocol/</guid>
                <pubDate>Sun, 11 Oct 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;I&amp;rsquo;ve been investigating applications that use the Signal Protocol in order to determine if the Signal Protocol for asynchronous messaging might be appropriate for use for applying to SecureDrop messaging in the future. In this post are some notes from reading the Signal Protocol specifications, which I thought might be a useful reference and explanation for others. If you notice an error, or have other thoughts on anything here, feel free to drop me a note on &lt;a href=&#34;https://twitter.com/redshiftzero&#34;&gt;Twitter&lt;/a&gt; or by &lt;a href=&#34;mailto:jen@redshiftzero.com&#34;&gt;email&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The protocol consists of two main parts, one for establishing key agreement between two parties, and another for &amp;ldquo;ratcheting&amp;rdquo; or deriving new ephemeral keys from that initial key material.&lt;/p&gt;
&lt;h1 id=&#34;key-agreement-using-extended-triple-diffie-hellman-x3dh&#34;&gt;Key Agreement using Extended Triple Diffie-Hellman (X3DH)&lt;/h1&gt;
&lt;p&gt;This is the process that occurs on first-time messages.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;The full description is covered in &lt;a href=&#34;https://signal.org/docs/specifications/x3dh/&#34;&gt;this specification&lt;/a&gt;. I use the same nomenclature as the specificiation for ease of comparison.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;X3DH is used in order to set up a shared secret between two parties. In this scenario we have a a server which is where we&amp;rsquo;ll store information in case either party is offline. We also have our two users:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Alice(👧🏼) who is online.&lt;/li&gt;
&lt;li&gt;Bob(👦🏽) who is offline. But Bob has helpfully published some data to the server for Alice to use to send him secure messages while he&amp;rsquo;s offline.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Alice👧🏼 and Bob👦🏽 will generate several elliptic curve key pairs using either Curve25519 or Curve448. How these curves can be used in Diffie-Hellman key exchange is described in &lt;a href=&#34;https://www.ietf.org/rfc/rfc7748.txt&#34;&gt;RFC 7748&lt;/a&gt;, Section 6.&lt;/p&gt;
&lt;p&gt;For Alice👧🏼, she has the following public keys:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;long-term identity public key $IK_A$&lt;/li&gt;
&lt;li&gt;emphemeral public key $EK_A$&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Bob👦🏽, who recall is offline, has published the following public keys to the server:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;long-term identity public key $IK_B$&lt;/li&gt;
&lt;li&gt;signed public prekey $SPK_B$. Bob👦🏽 will publish new signed prekeys from time to time, which will replace the old one. He obviously publishes both the prekey and the corresponding signature (with his long term identity key). When Bob👦🏽 replaces a prekey, he&amp;rsquo;ll want to delete the private key of the old keypair after waiting a period of time to allow for recently sent messages to be delivered.&lt;/li&gt;
&lt;li&gt;$n$ one-time public prekeys $OPK^{1}_{B}$&amp;hellip;$OPK_{B}^{n}$. Since these are one-time use, these will eventually run low (especially if Bob👦🏽 here is a popular fellow) so occasionally Bob will upload additional prekeys. When Bob receives a message using a public prekey, he&amp;rsquo;ll use the private key to process the message, and then delete the corresponding private key.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;When Alice👧🏼 wants to send an initial message, she:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Fetches Bob👦🏽&amp;rsquo;s long-term identity public key.&lt;/li&gt;
&lt;li&gt;Fetches Bob👦🏽&amp;rsquo;s signed public prekey and the signature. She verifies the signature (and stops if the verification fails).&lt;/li&gt;
&lt;li&gt;She fetches one of Bob👦🏽&amp;rsquo;s one-time public prekeys ($OPK^{1}_{B}$) - if one is available. Else she skips this step.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;These items are found in a &lt;a href=&#34;https://github.com/signalapp/libsignal-protocol-rust/blob/7e1dbcc26e5b681610498eb9fca31338da468be2/src/state/bundle.rs#L14-L24&#34;&gt;PreKeyBundle&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Next, four Diffie-Hellman (DH) shared secrets are derived using:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Alice👧🏼&amp;rsquo;s long term identity key $IK_A$ and Bob👦🏽&amp;rsquo;s signed pre-key $SPK_B$.&lt;/li&gt;
&lt;li&gt;Alice👧🏼&amp;rsquo;s emphemeral key $EK_A$ and Bob👦🏽&amp;rsquo;s long term identity key $IK_B$.&lt;/li&gt;
&lt;li&gt;Alice👧🏼&amp;rsquo;s emphemeral key $EK_A$ and Bob👦🏽&amp;rsquo;s signed pre-key $SPK_B$.&lt;/li&gt;
&lt;li&gt;Alice👧🏼&amp;rsquo;s emphemeral key $EK_A$ and Bob👦🏽&amp;rsquo;s one-time public prekeys $OPK^{1}_{B}$.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Since the private key material for DH secrets 3-4 above will be deleted after use, these provide &lt;em&gt;forward secrecy&lt;/em&gt;. This also means that in the future if an attacker collecting ciphertexts is able to compromise Alice👧🏼&amp;rsquo;s long-term identity key, the attacker cannot recover all four DH shared secrets since the ephmeral key material is long gone, thus they are unable to decrypt the ciphertexts encrypted using secrets derived from these DH secrets. By using the long-term identity keys - which can be verified using manual verification of safety numbers - in steps 1-2, these steps mutually authenticate Bob👦🏽 and Alice👧🏼.&lt;/p&gt;
&lt;p&gt;Next, DH outputs 1-3 (and 4 if available) are concatenated and used as an input for HKDF, an HMAC-based Key Derivation Function (KDF). A KDF does what it sounds like: takes some input and produces cryptographically strong key material. HKDF is defined in &lt;a href=&#34;https://www.ietf.org/rfc/rfc5869.txt&#34;&gt;RFC 5869&lt;/a&gt;. In our protocol, the output of HKDF is a shared key $SK$! These three (and sometimes four) DH key exchanges give the protocol its name.&lt;/p&gt;
&lt;p&gt;At this point, Alice👧🏼 can now send a message to Bob👦🏽. She sends him $IK_A$, $EK_A$, the ID of the one-time prekey she used ($OPK_{B1}$) (Bob👦🏽 will delete the corresponding private key material once he processes the message), and the ciphertext of her message encrypted using the shared key $SK$, which Bob👦🏽 can also derive.&lt;/p&gt;
&lt;h3 id=&#34;implications&#34;&gt;Implications&lt;/h3&gt;
&lt;p&gt;An attacker that is able to compromise the long-term identity key can masquerade as the user. They can sign prekeys and create new sessions. But, provided an attacker does not have access to previous ephemeral prekey (i.e. private) key material - which are deleted in the protocol after use - the attacker will not be able to reconstruct prior $SK$ and thus decrypt previous ciphertexts. If the private keys corresponding to currently uploaded prekeys, either one-time or signed, were compromised, they should be replaced.&lt;/p&gt;
&lt;p&gt;The specification also states that rate limits should be in place for getting a one-time prekey: this prevents an attacker from exhausting one-time prekeys, which would force Alice👧🏼 to fall back to using only Bob👦🏽&amp;rsquo;s signed prekey.&lt;/p&gt;
&lt;h1 id=&#34;double-ratchet-algorithm&#34;&gt;Double Ratchet Algorithm&lt;/h1&gt;
&lt;p&gt;At this point once the initial shared secret is established, the &amp;ldquo;ratchet&amp;rdquo; comes into play.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;The full description is covered in &lt;a href=&#34;https://signal.org/docs/specifications/doubleratchet/&#34;&gt;this specification&lt;/a&gt; in the Double Ratchet without header encryption section. I use the same nomenclature as the specificiation for ease of comparison.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&#34;kdf-chain&#34;&gt;KDF chain&lt;/h2&gt;
&lt;p&gt;A KDF chain is when a key and some additional input is used as input to a KDF, producting key material, some of which is used as a new KDF key, and some of which is used as an output key. The output keys are used, and the next step in the KDF chain uses the new KDF key as an input. Each step of the KDF chain looks like the following:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/KDFChain.png&#34; alt=&#34;KDF Chain single step&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;symmetric-key-ratchet&#34;&gt;Symmetric-key ratchet&lt;/h2&gt;
&lt;p&gt;A &amp;ldquo;symmetric ratchet&amp;rdquo; is a KDF chain that is used to derive per-message keys. Signal&amp;rsquo;s &amp;ldquo;Chain key&amp;rdquo; refers to the KDF key for each of the symmetric-key chains.&lt;/p&gt;
&lt;p&gt;A single step in the symmetric key ratchet looks like the following:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/SymmetricRatchet.png&#34; alt=&#34;Symmetric ratchet single step&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;dh-ratchet&#34;&gt;DH Ratchet&lt;/h2&gt;
&lt;p&gt;The DH ratchet is the process by which chain keys in the symmetric ratchet are updated.&lt;/p&gt;
&lt;p&gt;Each party has a ratchet key pair, which is a public-private Diffie-Hellman key pair.&lt;/p&gt;
&lt;p&gt;We observed in the X3DH protocol that in the first message Alice👧🏼 sent, she included the public part of her emphemeral key $EK_A$ such that bob could derive the same shared secret $SK$.&lt;/p&gt;
&lt;p&gt;In subsequent messages, Alice👧🏼 (and Bob👦🏽) can advertise new public keys (new &amp;ldquo;ratchet&amp;rdquo; public keys), which when Bob👦🏽 (and Alice👧🏼) receives he can use to construct new DH ratchet shared secrets using the local corresponding ratchet private key. Alice👧🏼 and Bob👦🏽 take turns ratcheting the DH secrets forward. Senders must include the sender ratchet key in each Signal message.&lt;/p&gt;
&lt;h2 id=&#34;signal-protocol&#34;&gt;Signal Protocol&lt;/h2&gt;
&lt;p&gt;Putting this together, Alice👧🏼 and Bob👦🏽 each have:&lt;/p&gt;
&lt;ol start=&#34;0&#34;&gt;
&lt;li&gt;a DH ratchet&lt;/li&gt;
&lt;li&gt;a root (symmetric-key) chain&lt;/li&gt;
&lt;li&gt;a sending (symmetric-key) chain&lt;/li&gt;
&lt;li&gt;a receiving (symmetric-key) chain&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Alice👧🏼&amp;rsquo;s sending chain and Bob👦🏽&amp;rsquo;s receiving chain are the same, similarly Alice👧🏼&amp;rsquo;s receiving chain and Bob👦🏽&amp;rsquo;s sending chain also are the same. Output keys from the sending and receiving chains are used for individual message encryption and decryption.&lt;/p&gt;
&lt;p&gt;Once a message key is used (i.e. for encryption or deletion), it is deleted by clients. If messages are delivered out of order, the receiver can just ratchet the chain forward to get the key material for the most recent delivered message, and store the message keys from the previous steps until they are delivered.&lt;/p&gt;
&lt;p&gt;The root chain takes as input DH secrets from the DH ratchet (derived as described in the prior section). The output keys from the root chain are new chain keys for the sending and receiving chains. As stated above, the message keys from those sending and receiving chains are used to encrypt and decrypt individual messages.&lt;/p&gt;
&lt;p&gt;The initial root key for the Double Ratchet protocol is the SK generated from the X3DH protocol. Initially $SPK_{B}$ becomes Bob👦🏽&amp;rsquo;s initial ratchet keypair.&lt;/p&gt;
&lt;h1 id=&#34;properties&#34;&gt;Properties&lt;/h1&gt;
&lt;p&gt;In summary, in addition to protecting the confidentiality of messages, some other useful properties of the above protocol are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Deniability&lt;/em&gt; - anyone can claim a message came from one of the participants at the end of a conversation.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Forward secrecy&lt;/em&gt; - If long-term keys are compromised, prior messages cannot be decrypted. The key material to decrypt them is ephemeral and will have been deleted.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Self-healing and &amp;ldquo;future secrecy&amp;rdquo;&lt;/em&gt; - If a key is compromised, the protocol &lt;em&gt;heals&lt;/em&gt;, meaning that future communications will return to a state unknown to the attacker. This is done by updating chain keys using the DH ratchet.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Authentication&lt;/em&gt; - If key fingerprints are mutually verified, the protocol provides end-to-end authentication.&lt;/li&gt;
&lt;/ul&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/signal/">Signal</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/signal/">Signal</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/security/">security</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/protocol/">protocol</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/cryptography/">cryptography</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Scanning for onion service availability</title>
                <link>https://www.redshiftzero.com/post/onion-available/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/onion-available/</guid>
                <pubDate>Tue, 06 Oct 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;&lt;a href=&#34;https://securethe.news/&#34;&gt;Secure The News&lt;/a&gt; (STN) is a project by Freedom of the Press Foundation to track and advocate for security and privacy technologies in news organizations. I&amp;rsquo;ve been working a bit on expanding the scope of STN from its original goal, HTTPS adoption, to how news sites treat Tor users.&lt;/p&gt;
&lt;p&gt;The first expansion is to &lt;a href=&#34;https://github.com/freedomofpress/securethenews/pull/262&#34;&gt;scan for onion service availability&lt;/a&gt; using the the &lt;code&gt;Onion-Location&lt;/code&gt; header (or its &lt;a href=&#34;https://github.com/freedomofpress/securethenews/pull/270&#34;&gt;presence&lt;/a&gt; in a &lt;code&gt;&amp;lt;meta&amp;gt;&lt;/code&gt; tag in the site&amp;rsquo;s page content). This is used by Tor Browser to alert users to the presence of an onion service.&lt;/p&gt;
&lt;p&gt;📈 Leaderboard: &lt;a href=&#34;https://securethe.news/&#34;&gt;https://securethe.news/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;📝 Blog announcement: &lt;a href=&#34;https://freedom.press/news/onions-side-tracking-tor-availability-reader-privacy-major-news-sites/&#34;&gt;https://freedom.press/news/onions-side-tracking-tor-availability-reader-privacy-major-news-sites/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;🐿️ Code: &lt;a href=&#34;https://github.com/freedomofpress/securethenews&#34;&gt;https://github.com/freedomofpress/securethenews&lt;/a&gt;&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/tor/">Tor</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/onion-services/">onion services</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/security/">security</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Tracking which wheels can be reproducibly built</title>
                <link>https://www.redshiftzero.com/post/reproducible-wheels/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/reproducible-wheels/</guid>
                <pubDate>Sat, 01 Aug 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Being able to &lt;a href=&#34;https://reproducible-builds.org/&#34;&gt;reproducibly build&lt;/a&gt; binary artifacts means that users, developers, and others can agree that the shipped artifact was correctly built from the source code (that one can inspect), and no intentional or unintentional malicious code was introduced during the build process.&lt;/p&gt;
&lt;p&gt;One hiccup we&amp;rsquo;ve encountered in SecureDrop development is that not all Python wheels can be built reproducibly. We ship multiple (Python) projects in debian packages, with Python dependencies included in those packages as wheels. In order for our debian packages to be reproducible, we need that wheel build process to also be reproducible. That wheel process &lt;em&gt;is&lt;/em&gt; reproducible (as of &lt;a href=&#34;https://wheel.readthedocs.io/en/latest/news.html&#34;&gt;pip wheel 0.27.0&lt;/a&gt; - see &lt;a href=&#34;https://github.com/pypa/wheel/issues/143&#34;&gt;relevant issue&lt;/a&gt;) if you set &lt;code&gt;SOURCE_DATE_EPOCH&lt;/code&gt; to be a constant value. However, there are still &lt;a href=&#34;https://github.com/pypa/wheel/issues/248&#34;&gt;sources&lt;/a&gt; of &lt;a href=&#34;https://github.com/pypa/pip/issues/6505&#34;&gt;nondeterminism&lt;/a&gt; for some projects.&lt;/p&gt;
&lt;p&gt;For our purposes, this has resulted in our building the wheels (once), saving those wheels on a pip mirror, and then using those wheels at debian package build time. A few times, we&amp;rsquo;ve asked &amp;ldquo;wait, which wheels can&amp;rsquo;t be reproducibly built again?&amp;rdquo;. So I made a little tracker on &lt;a href=&#34;https://reproduciblewheels.com/&#34;&gt;https://reproduciblewheels.com/&lt;/a&gt; for convenience.&lt;/p&gt;
&lt;p&gt;EDIT: As of August 19, 2020, passing a static &lt;code&gt;--build&lt;/code&gt; directory to the &lt;code&gt;pip wheel&lt;/code&gt; command below means that all currently tracked wheels are reproducible 🎉.&lt;/p&gt;
&lt;h2 id=&#34;how-it-works&#34;&gt;How it works&lt;/h2&gt;
&lt;p&gt;I first selected the 100 most popular packages on PyPI in the past year plus any dependencies that are on FPF&amp;rsquo;s &lt;a href=&#34;https://pypi.securedrop.org/simple/&#34;&gt;pip mirror&lt;/a&gt;&lt;sup id=&#34;fnref:1&#34;&gt;&lt;a href=&#34;https://www.redshiftzero.com/post/reproducible-wheels/#fn:1&#34; class=&#34;footnote-ref&#34; role=&#34;doc-noteref&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Then, I have a little &lt;a href=&#34;https://github.com/redshiftzero/reproduciblewheels/blob/main/check.py#L112-L161&#34;&gt;function&lt;/a&gt; that builds the wheel twice and then compares the SHA256 hash to determine if they are the same. The build command is:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;python3 -m pip wheel &amp;lt;project_name&amp;gt; --no-binary :all: --no-cache-dir
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Here &lt;code&gt;--no-binary :all:&lt;/code&gt; is used to ensure that I download the source tarball and &lt;code&gt;--no-cache-dir&lt;/code&gt; is used so that I don&amp;rsquo;t inadvertently use a cached built artifact.&lt;/p&gt;
&lt;p&gt;A &lt;a href=&#34;https://github.com/redshiftzero-bot&#34;&gt;friendly bot&lt;/a&gt; is running the above build function nightly for every monitored project, saving the results as &lt;a href=&#34;https://github.com/redshiftzero/reproduciblewheels/blob/main/site_data.json&#34;&gt;JSON&lt;/a&gt;, and then &lt;a href=&#34;https://github.com/redshiftzero/reproduciblewheels/blob/main/check.py#L87-L109&#34;&gt;updating the static HTML&lt;/a&gt;, which is deployed when it&amp;rsquo;s committed to the &lt;code&gt;main&lt;/code&gt; branch via GitHub pages. That&amp;rsquo;s it!&lt;/p&gt;
&lt;p&gt;If you find issues or think it should be tracking something else, just &lt;a href=&#34;https://github.com/redshiftzero/reproduciblewheels&#34;&gt;open an issue&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://reproduciblewheels.com&#34;&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/reproduciblewheels.png&#34; alt=&#34;reproduciblewheels&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&#34;footnotes&#34; role=&#34;doc-endnotes&#34;&gt;
&lt;hr&gt;
&lt;ol&gt;
&lt;li id=&#34;fn:1&#34;&gt;
&lt;p&gt;I should note here that from this set I excluded &lt;a href=&#34;https://github.com/redshiftzero/reproduciblewheels/blob/main/check.py#L31&#34;&gt;a few (7)&lt;/a&gt; projects that either required additional build requirements that I didn&amp;rsquo;t have out of the box in the build environment or had some other build-time issue (for the interested, this is ticket &lt;a href=&#34;https://github.com/redshiftzero/reproduciblewheels/issues/2&#34;&gt;#2&lt;/a&gt; on the bugtracker).&amp;#160;&lt;a href=&#34;https://www.redshiftzero.com/post/reproducible-wheels/#fnref:1&#34; class=&#34;footnote-backref&#34; role=&#34;doc-backlink&#34;&gt;&amp;#x21a9;&amp;#xfe0e;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/python/">python</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/wheels/">wheels</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/reproducible-builds/">reproducible builds</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Protecting journalists from malware using QubesOS</title>
                <link>https://www.redshiftzero.com/post/securedrop-qubes-workstation/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/securedrop-qubes-workstation/</guid>
                <pubDate>Fri, 31 Jul 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Earlier this year at USENIX Enigma, I presented some recent work towards rearchitecting the SecureDrop journalist experience.&lt;/p&gt;
&lt;p&gt;In SecureDrop we currently use an airgapped workstation for viewing documents to reduce the impact of malware present in malicious documents. This presents challenges in terms of maintenance, usability, and even security (i.e. airgaps don&amp;rsquo;t receive automatic updates).&lt;/p&gt;
&lt;p&gt;The basic idea of the rearchitecture of the journalist experience is to replace SecureDrop&amp;rsquo;s multi-machine airgap with a single machine using Qubes (Xen) for compartmentalization. This enables journalists to work with source materials in a secure environment, while still protecting them in the event of a system compromise. Check out the full talk here:&lt;/p&gt;
&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;https://www.youtube.com/embed/Z7BkdhO8P2I&#34; frameborder=&#34;0&#34; allow=&#34;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&#34; allowfullscreen&gt;&lt;/iframe&gt;
&lt;p&gt;After the talk, I decided to write up basically the above talk describing the design of the system in an expanded form in a whitepaper. &lt;a href=&#34;https://securedrop.org/documents/13/SD_Qubes_Workstation_Whitepaper.pdf&#34;&gt;Check out the full whitepaper here (PDF)&lt;/a&gt;.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/software-development/">Software Development</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/securedrop/">SecureDrop</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/qubes/">qubes</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/whistleblowing/">whistleblowing</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/whitepaper/">whitepaper</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Using HTTPS Everywhere rules for SecureDrop onion names</title>
                <link>https://www.redshiftzero.com/post/securedrop-httpse/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/securedrop-httpse/</guid>
                <pubDate>Fri, 31 Jul 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;A fun small project I worked on earlier this year was creating an HTTPS Everywhere custom ruleset channel for the SecureDrop project. HTTPS Everywhere is a popular browser extension maintained by EFF that rewrites HTTP URLs to HTTPS when possible. A set of rules is used to determine how URLs should be rewritten. HTTPS Everywhere is included in Tor Browser to reduce the impact of malicious exit nodes.&lt;/p&gt;
&lt;p&gt;This is relevant for SecureDrop, because each news organization advertises an onion URL that corresponds to the web application (&amp;ldquo;source interface&amp;rdquo;) where a source should upload documents. These URLs are not human readable: an example URL v2 onion services is &lt;code&gt;yyhws9optuwiwsns.onion&lt;/code&gt;. With v3 onion services, they are even longer: &lt;code&gt;l5satjgud6gucryazcyvyvhuxhr74u6ygigiuyixe3a6ysis67ororad.onion&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The HTTPS Everywhere folks &lt;a href=&#34;https://github.com/freedomofpress/securedrop/issues/3668&#34;&gt;suggested&lt;/a&gt; that we could use the &lt;a href=&#34;https://github.com/EFForg/https-everywhere/blob/master/docs/en_US/ruleset-update-channels.md&#34;&gt;custom ruleset functionality&lt;/a&gt; in HTTPS Everywhere to create a list of rules rewriting human-readable names to the onion URLs for SecureDrop source interface. This can be scoped to a namespace such that this custom ruleset can only rewrite URLs that end in e.g. &lt;code&gt;securedrop.tor.onion&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Here&amp;rsquo;s a little gif showing the rewriting:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/onion_redirect.gif&#34; alt=&#34;ayy Leak docs to LPL&#34;&gt;&lt;/p&gt;
&lt;p&gt;We created a ruleset channel with organizations that opted-in, allowing them to rewrite e.g. &lt;code&gt;lucyparsonslabs.securedrop.tor.onion&lt;/code&gt; to the underlying onion URL. Check &lt;a href=&#34;https://github.com/freedomofpress/securedrop-https-everywhere-ruleset&#34;&gt;the repository&lt;/a&gt; out if you&amp;rsquo;re curious to see the logic we use to maintain and update the rules. Our ruleset channel was included in stable Tor Browser beginning with &lt;a href=&#34;https://blog.torproject.org/new-release-tor-browser-95&#34;&gt;the 9.5 release&lt;/a&gt;.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/securedrop/">SecureDrop</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/tor/">tor</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/naming/">naming</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Handling equal priority jobs using queue.PriorityQueue</title>
                <link>https://www.redshiftzero.com/post/priority-queue/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/priority-queue/</guid>
                <pubDate>Mon, 13 Jan 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;A queue retrives items in FIFO (first in, first out) order. A priority queue retrieves item based on &lt;em&gt;priority&lt;/em&gt;, higher priority items come first. Well, what happens if you submit items that have equal priorities? It depends on how the priority queue was implemented. Read on for how this is handled in the Python standard library&amp;rsquo;s  &lt;code&gt;queue.PriorityQueue&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s see &lt;code&gt;queue.PriorityQueue&lt;/code&gt; in action in a simple case:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;queue&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;PriorityQueue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;PriorityQueue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;A&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;B&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;C&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;A&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;B&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;C&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;empty&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kc&#34;&gt;True&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;As we can see, we&amp;rsquo;ve put &lt;code&gt;(priority_number, data)&lt;/code&gt; into the queue, and retrieved them using the &lt;code&gt;get()&lt;/code&gt; method. We see that lower numbers correspond to higher priorities.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s now add some jobs with equal priorities and retrieve them:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;My first job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;Another job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;Another job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;My first job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;We did not retrieve items in FIFO order for jobs of equal priority: &lt;code&gt;&#39;Another job&#39;&lt;/code&gt; was fetched prior to &lt;code&gt;&#39;My first job&#39;&lt;/code&gt; even though it was added afterwards. Why does this happen?&lt;/p&gt;
&lt;h2 id=&#34;using-a-min-heap-for-queuepriorityqueue&#34;&gt;Using a min-heap for &lt;code&gt;queue.PriorityQueue&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;The short version is that we grabbed &lt;code&gt;&#39;Another job&#39;&lt;/code&gt; first, because &lt;code&gt;&#39;Another job&#39; &amp;lt; &#39;My first job&#39;&lt;/code&gt; alphabetically.&lt;/p&gt;
&lt;p&gt;The longer version is that under the hood, &lt;code&gt;queue.PriorityQueue&lt;/code&gt; is implemented using &lt;code&gt;heapq&lt;/code&gt;, Python&amp;rsquo;s heap implementation. Every job is an element in a min-heap. A min-heap is a complete binary tree that satisfies the min-heap propety: the value of each node is greater than or equal to the value of its parent. The root element will be the node with the minimum value. So to get the next job we want to run, we just &lt;a href=&#34;https://github.com/python/cpython/blob/b2b4a51f7463a0392456f7772f33223e57fa4ccc/Lib/heapq.py#L139&#34;&gt;grab the element at the top of the min-heap&lt;/a&gt;, which due to the min-heap property, we know will be the job with the minimum priority value - which remember from above corresponds to the &lt;em&gt;higher&lt;/em&gt; priority.&lt;/p&gt;
&lt;p&gt;But where is this comparison done: &lt;code&gt;&#39;Another job&#39; &amp;lt; &#39;My first job&#39;&lt;/code&gt;? During heap operations, elements are compared with one another (and swapped if needed). In Python, this is done using &lt;a href=&#34;https://github.com/python/cpython/blob/b2b4a51f7463a0392456f7772f33223e57fa4ccc/Lib/heapq.py#L264&#34;&gt;the rich comparison operator &lt;code&gt;__lt__&lt;/code&gt;&lt;/a&gt;. &lt;code&gt;&#39;Another job&#39;&lt;/code&gt; will bubble to the top of the heap since &lt;code&gt;&#39;Another job&#39; &amp;lt; &#39;My first job&#39;&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;how-we-can-solve-this&#34;&gt;How we can solve this&lt;/h2&gt;
&lt;p&gt;Here&amp;rsquo;s an approach I used for Python 3.5 (the version of Python I was writing for when I looked into using &lt;a href=&#34;https://github.com/freedomofpress/securedrop-client/blob/master/securedrop_client/api_jobs/base.py#L24&#34;&gt;this functionality&lt;/a&gt;). For the application I was working on, I needed to retrieve items based on priority, and for items of equal priority, I needed to retrieve items in FIFO order.&lt;/p&gt;
&lt;p&gt;One simple approach if you hit this problem is following &lt;a href=&#34;https://docs.python.org/3/library/heapq.html#priority-queue-implementation-notes&#34;&gt;a suggestion in the &lt;code&gt;heapq&lt;/code&gt; documentation&lt;/a&gt;: &amp;ldquo;store entries as 3-element list including the priority, an entry count, and the task&amp;rdquo;, where the entry count is a tie-breaker for jobs of equal priority. Let&amp;rsquo;s see that demonstrated:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;My next job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;Another job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;My next job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;q&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;Another job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;In my situation, I was working in a codebase that had already a mediator interface to submit jobs (to &lt;code&gt;queue.PriorityQueue&lt;/code&gt;), and job objects themselves were separate objects (i.e. not simple strings in the real applicatoin). I ended up making jobs sortable using the following superclass that implemented the &lt;code&gt;__lt__&lt;/code&gt; rich comparison method:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;typing&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;TypeVar&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;QueueJobType&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;TypeVar&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;QueueJobType&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;bound&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;QueueJob&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;QueueJob&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__init__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;order_number&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;None&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_number&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;order_number&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;task&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__lt__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;other&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;QueueJobType&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;s1&#34;&gt;&amp;#39;&amp;#39;&amp;#39;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;        We need to use the order_number key to break ties to ensure
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;        that objects are retrieved in FIFO order.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;s1&#34;&gt;        &amp;#39;&amp;#39;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_number&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;other&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_number&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__repr__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;task&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;When I submitted jobs, I&amp;rsquo;d do so using an interface like this (application simplified for demonstration purposes, more context is &lt;a href=&#34;https://github.com/freedomofpress/securedrop-client/blob/master/securedrop_client/queue.py&#34;&gt;here&lt;/a&gt;) that would set the &lt;code&gt;order_number&lt;/code&gt; such that it would be monotonically increasing:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;itertools&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;queue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;App&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;fm&#34;&gt;__init__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_number&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;itertools&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;count&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;queue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;PriorityQueue&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;add_task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;priority&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;n&#34;&gt;current_order_number&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;next&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;order_number&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;n&#34;&gt;task&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;QueueJob&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;current_order_number&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;put&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;priority&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s see if jobs with equal priorities are retrieved in FIFO order:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;stuff&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;App&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;app&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;App&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;app&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;add_task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;My first job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;app&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;add_task&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;Another job&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;app&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;My&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;first&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;o&#34;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;app&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;get&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Another&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;job&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Jobs with equal priorities are retrieved in FIFO order, which is what we wanted.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/software-development/">Software Development</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/data-structures/">data structures</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/queue/">queue</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/python/">python</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>A pytest fixture for image similarity</title>
                <link>https://www.redshiftzero.com/post/pytest-image/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/pytest-image/</guid>
                <pubDate>Sun, 12 Jan 2020 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;When testing codepaths that generate images, one might want to ensure that the generated image is what is expected. &lt;a href=&#34;https://matplotlib.org&#34;&gt;Matplotlib&lt;/a&gt; has a nice decorator &lt;a href=&#34;https://matplotlib.org/devel/testing.html#writing-an-image-comparison-test&#34;&gt;&lt;code&gt;@image_comparison&lt;/code&gt;&lt;/a&gt; that can be applied for this purpose, but looking at &lt;a href=&#34;https://github.com/matplotlib/matplotlib/blob/f653879c6317b191849c49511282cfff949ad336/lib/matplotlib/testing/decorators.py#L165&#34;&gt;the implementation&lt;/a&gt;, it&amp;rsquo;s pretty tied to the &lt;code&gt;matplotlib&lt;/code&gt; &lt;code&gt;Figure&lt;/code&gt; object. I wanted something generic to use with PNGs.&lt;/p&gt;
&lt;p&gt;I ended up writing a pytest fixture that would compare the image generated during the test with a baseline image (in &lt;code&gt;tests/baseline_images&lt;/code&gt; as in the matplotlib implementatino). Here are the contents of &lt;code&gt;conftest.py&lt;/code&gt;, which contain the fixture and its related image similarity assert:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;31
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;32
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;33
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;os&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;pytest&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;numpy&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;as&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;np&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;kn&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;PIL&lt;/span&gt; &lt;span class=&#34;kn&#34;&gt;import&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Image&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;assert_images_equal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;image_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;image_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;img1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Image&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;open&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;image_1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;img2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;Image&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;open&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;image_2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;c1&#34;&gt;# Convert to same mode and size for comparison&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;img2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;img2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;convert&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;img1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mode&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;img2&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;img2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;img1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;size&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;sum_sq_diff&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;((&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;asarray&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;img1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;astype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;float&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;asarray&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;img2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;astype&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;float&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;**&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sum_sq_diff&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;c1&#34;&gt;# Images are exactly the same&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;k&#34;&gt;pass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;n&#34;&gt;normalized_sum_sq_diff&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;sum_sq_diff&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;/&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;np&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sqrt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum_sq_diff&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;k&#34;&gt;assert&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;normalized_sum_sq_diff&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;mf&#34;&gt;0.001&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nd&#34;&gt;@pytest&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fixture&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;image_similarity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;tmpdir&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;testname&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;node&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;name&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;filename&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;{}&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;.png&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;testname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;generated_file&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;os&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;join&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;str&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;tmpdir&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;{}&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;.png&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;testname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;yield&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;filename&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;generated_file&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;assert_images_equal&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;tests/baseline_images/&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;{}&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;.png&amp;#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;format&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;testname&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;generated_file&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;The assert rescales the images to be the same size, as well as the same mode, and then computes the sum of the squared differences as an image similarity metric.&lt;/p&gt;
&lt;p&gt;You can use the above fixture in a test via:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-py&#34; data-lang=&#34;py&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;test_example&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;image_similarity&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;c1&#34;&gt;# test logic goes here and should generate an image in the&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;c1&#34;&gt;# path given by image_similarity[&amp;#39;filename&amp;#39;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;pass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;When you add a new test, you need to add the expected image to &lt;code&gt;tests/baseline_images/&amp;lt;testname&amp;gt;.png&lt;/code&gt;.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/software-development/">Software Development</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/tests/">tests</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/image/">image</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/pytest/">pytest</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/python/">python</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>How to apply unittest.mock.patch</title>
                <link>https://www.redshiftzero.com/post/unittest-mock-patch/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/unittest-mock-patch/</guid>
                <pubDate>Sun, 01 Dec 2019 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;I&amp;rsquo;ve noticed a common area of misunderstanding for people newer to Python testing is &lt;em&gt;how&lt;/em&gt; to apply &lt;code&gt;mock.patch&lt;/code&gt; and &lt;em&gt;where&lt;/em&gt; to patch (i.e. what the &lt;code&gt;target&lt;/code&gt; positional argument to &lt;code&gt;unittest.mock.patch&lt;/code&gt; should be), so I made a video explaining:&lt;/p&gt;
&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;https://www.youtube.com/embed/WFRljVPHrkE&#34; frameborder=&#34;0&#34; allow=&#34;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&#34; allowfullscreen&gt;&lt;/iframe&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/testing/">Testing</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/software-development/">Software Development</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/tests/">tests</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/python/">python</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/101/">101</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Implementing the CBC padding oracle attack</title>
                <link>https://www.redshiftzero.com/post/cbc-padding/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/cbc-padding/</guid>
                <pubDate>Fri, 29 Nov 2019 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;The CBC padding oracle attack demonstrates how what might initially seem like a small issue can balloon into a devastating attack that can result in total reconstruction of the plaintext by the attacker. It&amp;rsquo;s also one of the harder challenges in &lt;a href=&#34;https://cryptopals.com/sets/3/challenges/17&#34;&gt;Set 3 of Cryptopals&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;the-problem&#34;&gt;The problem&lt;/h2&gt;
&lt;p&gt;It goes like this: an attacker has access to an oracle that will take a ciphertext (i.e. what we need to decrypt) and return a boolean indicating whether or not the padding was valid. My padding oracle function looked like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;cbc_padding_oracle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ciphertext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;iv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;bytes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;bool&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;try&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;n&#34;&gt;aes_cbc_decrypt&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ciphertext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;iv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;remove_padding&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;kc&#34;&gt;True&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;True&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;except&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;BadPaddingValidation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kc&#34;&gt;False&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;where &lt;code&gt;BadPaddingValidation&lt;/code&gt; was a custom exception indicating that - you guessed it - the padding was invalid.&lt;/p&gt;
&lt;p&gt;The following (16-byte) block has valid padding:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/one_byte_of_padding.png&#34; alt=&#34;One byte of valid padding&#34;&gt;&lt;/p&gt;
&lt;p&gt;and our oracle will tell us that. This means that we learn something about the plaintext.&lt;/p&gt;
&lt;p&gt;From this fact alone, we can decrypt the ciphertext.&lt;/p&gt;
&lt;h2 id=&#34;how-it-works&#34;&gt;How it works&lt;/h2&gt;
&lt;p&gt;Looking at how CBC decryption works, we can figure out how to use this fact to get the plaintext:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/cbc_decrypt.png&#34; alt=&#34;CBC Decryption&#34;&gt;&lt;/p&gt;
&lt;p&gt;Well, we don&amp;rsquo;t know the IV so let&amp;rsquo;s ignore that. We do have all the ciphertext blocks. And we can learn if the final N bytes of any given plaintext are valid via our oracle.&lt;/p&gt;
&lt;p&gt;Looking at the diagram we can see that:&lt;/p&gt;
&lt;p&gt;$c_{n-1} \oplus \mbox{decrypt}(c_n, k) = p_n$&lt;/p&gt;
&lt;p&gt;As the attacker, we&amp;rsquo;ll copy $c_{n-1}$ to a test block we&amp;rsquo;ll call $t$ and introduce a single bit change in the final byte:&lt;/p&gt;
&lt;p&gt;$t \oplus \mbox{decrypt}(c_n, k) = p_n$&lt;/p&gt;
&lt;p&gt;We&amp;rsquo;ll keep introducing single bit changes in the final byte &lt;em&gt;until&lt;/em&gt; we get a valid response from the oracle. Then we&amp;rsquo;ve learned:&lt;/p&gt;
&lt;p&gt;$t[15] \oplus \mbox{decrypt}(c_n, k)[15] = 01$&lt;/p&gt;
&lt;p&gt;Rearranging:&lt;/p&gt;
&lt;p&gt;$\mbox{decrypt}(c_n, k)[15] = 01 \oplus t[15]$&lt;/p&gt;
&lt;p&gt;Meaning that we learned about the final byte of the block cipher decryption output which we can reuse now with $c_{n-1}$ and $c_n$ to get the real final byte of plaintext:&lt;/p&gt;
&lt;p&gt;$p_n[15] = c_{n-1}[15] \oplus \mbox{decrypt}(c_n, k)[15]$&lt;/p&gt;
&lt;p&gt;That&amp;rsquo;s the first byte reconstructed.&lt;/p&gt;
&lt;h2 id=&#34;lets-go&#34;&gt;Let&amp;rsquo;s go&lt;/h2&gt;
&lt;p&gt;Starting at the rightmost block, we can move right to left decrypting each plaintext byte.&lt;/p&gt;
&lt;p&gt;For bytes that &lt;em&gt;aren&amp;rsquo;t&lt;/em&gt; the final byte in the block, we can use what we learned so far in the block to compute what the valid padding bytes would be for the bytes right of the target byte. For example, for the second-to-last byte, we are looking for padding that validates to:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/two_byte_of_padding.png&#34; alt=&#34;Two bytes of valid padding&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can compute the final byte of our test ciphertext such that it will equal our desired padding byte value &lt;code&gt;02&lt;/code&gt;:&lt;/p&gt;
&lt;p&gt;$t[15] = \mbox{decrypt}(c_n, k)[15] \oplus 02$&lt;/p&gt;
&lt;p&gt;So as we decrypt each block we just need to keep track of the output of the block cipher prior to the xor so we can compute this.&lt;/p&gt;
&lt;h2 id=&#34;one-gotcha&#34;&gt;One gotcha&lt;/h2&gt;
&lt;p&gt;I got the above working pretty quickly, but realized my attack was not working reliably. Occasionally, I guessed the wrong answer early on in the plaintext reconstruction. Debugging I discovered the following case when reconstructing the first byte:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/degenerate_ciphertexts.png&#34; alt=&#34;Degenerate ciphertexts&#34;&gt;&lt;/p&gt;
&lt;p&gt;There can be multiple &amp;ldquo;correct&amp;rdquo; answers for a given byte, i.e. there can be multiple ciphertexts that will have valid padding. Here in the example we have two valid ciphertexts when computing the last byte in the ciphertext: one with &lt;code&gt;01&lt;/code&gt; in the final byte position (what we&amp;rsquo;re looking for) and one where the second-to-last byte is &lt;code&gt;02&lt;/code&gt; and produces a valid padding result (not what we&amp;rsquo;re looking for).&lt;/p&gt;
&lt;p&gt;To handle this case, before settling on a given byte, I&amp;rsquo;d first modify the byte &lt;em&gt;before&lt;/em&gt; the target byte and check if the padding was still valid:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;byte_num_to_edit&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block_size&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;+&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;byte_num&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;degeneracy_ciphertext&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;flip_nth_bit&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;full_test_ciphertext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;byte_num_to_edit&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block_size&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;cbc_padding_oracle&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;key&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;degeneracy_ciphertext&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;bp&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;iv&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;pass&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;continue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;This enabled me to distinguish between the two above cases, and ensure that there was only a single, correct answer for each byte.&lt;/p&gt;
&lt;p&gt;My solution is &lt;a href=&#34;https://github.com/redshiftzero/cryptopals/commit/28ea3ebe1febafeac712af65fbfce141b8740e49&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/cryptography/">Cryptography</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/cryptography/">cryptography</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/cryptopals/">cryptopals</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/block-ciphers/">block ciphers</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Using pyreverse to generate UML class diagrams</title>
                <link>https://www.redshiftzero.com/post/pyreverse-uml/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/pyreverse-uml/</guid>
                <pubDate>Mon, 25 Nov 2019 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Recently I wanted to generate UML (Unified Modeling Language) diagrams of the structure of an existing codebase for the purpose of having an architecture discussion.&lt;/p&gt;
&lt;p&gt;I was wondering if there was a tool to generate UML diagrams in Python to save me some manual work.&lt;/p&gt;
&lt;p&gt;Enter &lt;a href=&#34;https://pypi.org/project/pyreverse/&#34;&gt;&lt;code&gt;pyreverse&lt;/code&gt;&lt;/a&gt;: it comes installed with &lt;code&gt;pylint&lt;/code&gt; which is a very common development dependency in Python. &lt;code&gt;pyreverse&lt;/code&gt; enables you to point to the code you want UML diagrams of, here in my example I was generating a diagram of a project called &lt;a href=&#34;https://github.com/freedomofpress/securedrop-export&#34;&gt;&lt;code&gt;securedrop-export&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pyreverse securedrop_export/
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;This produces in the same directory a graphviz file called &lt;code&gt;classes.dot&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Then, provided you have graphviz (which provides the &lt;code&gt;dot&lt;/code&gt; command) installed:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;dot -Tpng classes.dot -o securedrop_export.png
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Which produces the following:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/securedrop_export.png&#34; alt=&#34;securedrop-export&#34;&gt;&lt;/p&gt;
&lt;p&gt;Here &lt;code&gt;ExportStatus&lt;/code&gt; is an &lt;code&gt;Enum&lt;/code&gt; and &lt;code&gt;TimeoutException&lt;/code&gt; is a custom exception (in red).&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/software-development/">Software Development</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/uml/">UML</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/object-oriented/">object oriented</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/python/">python</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Debugging programs with pdb</title>
                <link>https://www.redshiftzero.com/post/pdb-debugging/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/pdb-debugging/</guid>
                <pubDate>Sat, 23 Nov 2019 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;I recently decided to try my hand at making YouTube videos. I&amp;rsquo;m planning on mostly making videos about topics I commonly find myself explaining to people, so here&amp;rsquo;s the first, on using pdb, the built-in debugger in the Python standard library.&lt;/p&gt;
&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;https://www.youtube.com/embed/IzgSl-tkPPg&#34; frameborder=&#34;0&#34; allow=&#34;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&#34; allowfullscreen&gt;&lt;/iframe&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/testing/">Testing</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/software-development/">Software Development</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/tests/">tests</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/python/">python</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/debugging/">debugging</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Strategies for handling flaky test suites</title>
                <link>https://www.redshiftzero.com/post/test-flakes/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/test-flakes/</guid>
                <pubDate>Fri, 19 Jul 2019 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Test flakes are tests that occasionally fail due to a variety of potential reasons including network instability (for tests making network calls that are not mocked) and other non-deterministic behavior. Test flakes are problematic as they reduce confidence in the results of test runs: they condition developers that the test suite cannot be relied on, and as such can result in legitimate bugs being ignored due to &lt;a href=&#34;https://en.wikipedia.org/wiki/Alarm_fatigue&#34;&gt;alert fatigue&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This post contains some strategies for identifying and handling flaky tests in Python.&lt;/p&gt;
&lt;h3 id=&#34;identify-track-and-fix&#34;&gt;Identify, track, and fix&lt;/h3&gt;
&lt;p&gt;One strategy is once a flake is identified to treat them like any other bug:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;File an issue to track it such that there is awareness of the flakey test.&lt;/li&gt;
&lt;li&gt;Reproduce the flake locally.&lt;/li&gt;
&lt;li&gt;Fix whatever underlying reason is causing the flaky behavior.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;A common problem is to skip step 2, and instead take a guess why the flake is happening, and then modify the behavior. To prevent unnecessary implementation/review time, it&amp;rsquo;s worth resisting this urge and to at least try to understand the behavior prior to making changes. If it proves particularly troublesome to identify, &lt;em&gt;then&lt;/em&gt; it may be reasonable to make some experimental fixes.&lt;/p&gt;
&lt;p&gt;One strategy to identify the underlying problem is to use a plugin like &lt;code&gt;pytest-repeat&lt;/code&gt; (&lt;code&gt;pip install pytest-repeat&lt;/code&gt;) to run a &lt;em&gt;single&lt;/em&gt; test a large number of times:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pytest --count &lt;span class=&#34;m&#34;&gt;100&lt;/span&gt; tests/test_app.py::test_my_flaky_behavior
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;You can do this on your main branch to reproduce the flake (adjusting the &lt;code&gt;count&lt;/code&gt; as needed based on the failure rate of the test), and then run again once you have applied a fix to verify that it indeed resolves the issue.&lt;/p&gt;
&lt;h3 id=&#34;automatically-re-run-flaky-tests&#34;&gt;Automatically re-run flaky tests&lt;/h3&gt;
&lt;p&gt;Alternatively, a quick fix if you don&amp;rsquo;t want to take the time to address the underlying issues in the test suite is a pytest plugin called &lt;a href=&#34;https://github.com/box/flaky&#34;&gt;&lt;code&gt;flaky&lt;/code&gt;&lt;/a&gt; (&lt;code&gt;pip install flaky&lt;/code&gt;). One can use this to re-run individual flaky tests or classes of flaky tests up to a configurable number of times, e.g.:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nd&#34;&gt;@flaky&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;max_runs&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;test_my_flaky_behavior&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;():&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;expected_result&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;result&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;actual_result&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;my_function&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;arg1&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;arg2&amp;#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;assert&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;expected_result&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;actual_result&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;flaky-test-dashboard&#34;&gt;Flaky test dashboard&lt;/h3&gt;
&lt;p&gt;If you use a CI provider like Circle CI, you can see which tests are the most flaky (and use that to prioritize fixes) if you export test metadata:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pytest --junitxml&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;~/project/test-results/junit.xml
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;And then export them to Circle CI using their &lt;code&gt;store_test_results&lt;/code&gt; and &lt;code&gt;store_artifacts&lt;/code&gt; steps:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-yaml&#34; data-lang=&#34;yaml&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;- &lt;span class=&#34;nt&#34;&gt;store_test_results&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;~/project/test-results&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;&lt;/span&gt;- &lt;span class=&#34;nt&#34;&gt;store_artifacts&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;w&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;nt&#34;&gt;path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;w&#34;&gt; &lt;/span&gt;&lt;span class=&#34;l&#34;&gt;~/project/test-results&lt;/span&gt;&lt;span class=&#34;w&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;These tests results, as CI jobs fail due to flakes, will populate a dashboard at &lt;a href=&#34;https://circleci.com/build-insights&#34;&gt;https://circleci.com/build-insights&lt;/a&gt; which will contain the most often failed tests, along with other useful information like the longest running failed tests.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/testing/">Testing</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/software-development/">Software Development</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/tests/">tests</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/flakes/">flakes</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/pytest/">pytest</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/circleci/">circleci</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Collision attacks and the birthday paradox</title>
                <link>https://www.redshiftzero.com/post/birthday-attacks/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/birthday-attacks/</guid>
                <pubDate>Sun, 19 May 2019 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;How many people do you need in a room before there is a 50% chance that least two of them share the same birthday? It&amp;rsquo;s only 23, though unless you have heard about this paradox before, you might expect it to be much larger. This is the well-known birthday paradox: it&amp;rsquo;s called a paradox only because collisions happen much faster than one naively expects. Collisions here means an event where two or more observed values are equal. This paradox is important in cryptography as it&amp;rsquo;s relevant for many topics like cryptographic hash functions, which are designed to be collision-resistant one-way functions.&lt;/p&gt;
&lt;h3 id=&#34;the-probability-of-collision&#34;&gt;The probability of collision&lt;/h3&gt;
&lt;p&gt;Let&amp;rsquo;s see why this is true by first deriving analytically the probability that &lt;em&gt;no&lt;/em&gt; collision occurs for a generic case where there are $m$ possible values, and we observe $n$ of them. The birthday paradox above is a special case where $m=365$ and $n=23$. We want to know: what is the probability that we don&amp;rsquo;t see any collisions after $n$ observations?&lt;/p&gt;
&lt;p&gt;We first note that the first observation, $o_1$, trivially occurs with probability 1: $P(o_1) = 1$.&lt;/p&gt;
&lt;p&gt;Next we compute the probability that the second observation does not match the first, there are now $m-1$ possible options out of $m$:&lt;/p&gt;
&lt;p&gt;$P(o_2 \ne o_1) = \frac{m - 1}{m} = 1 - \frac{1}{m}$&lt;/p&gt;
&lt;p&gt;Now the third, which should not match either the first or the second:&lt;/p&gt;
&lt;p&gt;$P(o_3 \ne o_1 \ne o_2) = \frac{m - 2}{m} = 1 - \frac{2}{m}$&lt;/p&gt;
&lt;p&gt;And so on and so forth until the $n$th observation, which should not match any of
the first $n-1$ observations:&lt;/p&gt;
&lt;p&gt;$P(o_n \ne o_1 \ne o_2 &amp;hellip; \ne o_{n-1}) = \frac{m - (n - 1)}{m} = 1 - \frac{n-1}{m}$&lt;/p&gt;
&lt;p&gt;The probability of no collisions is just the joint probability of these events (assuming that they&amp;rsquo;re independent):&lt;/p&gt;
&lt;p&gt;$ P(\mbox{No collision}) = \prod_{i=1}^{n} P(o_i) = \prod_{i=1}^{n-1} 1 - \frac{i}{m}$&lt;/p&gt;
&lt;p&gt;What is the probability that a collision &lt;em&gt;does&lt;/em&gt; occur? Well, we know that the probability that a collision occurs is the complement of the probability that no collision occurs, i.e.:&lt;/p&gt;
&lt;p&gt;$ P(\mbox{Collision}) = 1 - P(\mbox{No collision}) = 1 - \prod_{i=1}^{n-1} 1 - \frac{i}{m}$&lt;/p&gt;
&lt;p&gt;That is the probability for any $n$ and $m$ that a collision occurs due to the birthday paradox ✨&lt;/p&gt;
&lt;h3 id=&#34;collision-probability-as-a-function-of-n&#34;&gt;Collision probability as a function of $n$&lt;/h3&gt;
&lt;p&gt;Armed with the above analytic expression, we can write a simple function that computes the probability of collision for any $n$ and $m$:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;prob_of_collision&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;n&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;23&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;365&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;int&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;probability_of_no_collision&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;range&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;n&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;):&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        &lt;span class=&#34;n&#34;&gt;probability_of_no_collision&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*=&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;probability_of_no_collision&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Let&amp;rsquo;s now use this function to make a few plots showing how the probability changes as a function of $n$.&lt;/p&gt;
&lt;h4 id=&#34;birthday-case-m365&#34;&gt;Birthday case: m=365&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/birthday_attack_m_365.png&#34; alt=&#34;Collision probability for m=365&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can see that the probability reaches $50%$ right around $n=23$, thus recovering what we stated in the introduction.&lt;/p&gt;
&lt;h4 id=&#34;larger-case-m100000&#34;&gt;Larger case: m=100000&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/birthday_attack_m_100000.png&#34; alt=&#34;Collision probability for m=365&#34;&gt;&lt;/p&gt;
&lt;p&gt;For larger numbers, we see that collisions happen &lt;em&gt;very&lt;/em&gt; fast: in a space of 100000 possible values, we reach $50%$ probability after less than 400 observations. This should underscore the importance of considering birthday attacks especially in the case even where the space of possible values is very large. We can see empirically from these couple of cases that the number of observations $n$ you need to get a probability of collision of 0.5 is approximately $\sqrt{m}$. You can prove that to yourself analytically by taking the equation we derived above for the probability of collision, setting the left hand side equal to 0.5, and rearranging to see the relationship between $n$ and $m$.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/cryptography/">Cryptography</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/statistics/">Statistics</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/cryptography/">cryptography</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/101/">101</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/teaching/">teaching</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/statistics/">statistics</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/hash-functions/">hash functions</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Why Publishing Data on ICE Employees is in the Public Interest</title>
                <link>https://www.redshiftzero.com/post/publishing-public-interest/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/publishing-public-interest/</guid>
                <pubDate>Thu, 21 Jun 2018 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;&lt;em&gt;This was written with &lt;a href=&#34;https://www.camillefassett.com/&#34;&gt;Camille Fassett&lt;/a&gt; and first appeared on &lt;a href=&#34;https://lucyparsonslabs.com/posts/ice-public-interest/&#34;&gt;the website of the Lucy Parsons Labs&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Motivated by the Trump administration’s &lt;a href=&#34;https://www.washingtonpost.com/news/fact-checker/wp/2018/06/19/the-facts-about-trumps-policy-of-separating-families-at-the-border/&#34;&gt;policy&lt;/a&gt; of detaining and separating migrant children from their families at the border, artist and developer Sam Lavigne harvested profiles that list Immigration and Customs Enforcement (ICE) as an employer on social network LinkedIn.&lt;/p&gt;
&lt;p&gt;He made the dataset of all 1595 responsive profiles, which included names, titles, photographs and general locations, available to download on GitHub. The repository also included the Python script that he used to scrape LinkedIn, along with basic instructions on how to replicate his work.&lt;/p&gt;
&lt;p&gt;“While I don’t have a precise idea of what should be done with this data set, I leave it here with the hope that researchers, journalists and activists will find it useful,” Lavigne &lt;a href=&#34;https://web.archive.org/web/20180619140914/https://medium.com/@samlavigne/downloading-the-profiles-of-everyone-on-linkedin-who-works-for-ice-c4e0ff6b065e&#34;&gt;wrote&lt;/a&gt; in a Medium post about the profiles he scraped.&lt;/p&gt;
&lt;p&gt;But at the URL where the dataset was hosted is now just a page that reads: “This repository has been disabled. Access to this repository has been disabled by GitHub staff.” And in place of Lavigne’s explainer on Medium is simply, “This page is unavailable.”&lt;/p&gt;
&lt;p&gt;GitHub and Medium aren’t the only entities that scrubbed Lavigne’s work from their platforms. Twitter also suspended @iceHRgov, an account that tweeted profiles from the dataset.&lt;/p&gt;
&lt;p&gt;A spokesperson for GitHub stated that the repository was removed because it violated its community guidelines—specifically, those that prohibit doxxing, harassment, and violating a third party’s privacy.&lt;/p&gt;
&lt;p&gt;But doxxing is targeting private individuals for harassment by exposing their private, personal information. ICE is a government agency, and its employees on the ground are in public, acting in their capacity as government officials. As journalist Sarah Jeong, the author of a book about online harassment titled The Internet of Garbage, &lt;a href=&#34;https://sarahjeong.net/2015/07/08/stop-diluting-the-definition-of-dox/&#34;&gt;has written&lt;/a&gt;, “The definition of doxing is the publication of a physical residential address, or information protected by law (social security numbers, medical records, and so forth).”&lt;/p&gt;
&lt;p&gt;“Unmasking someone by their full name, identifying someone by their first name, identifying their place of work, or screencapping e-mails are not doxing. They are—once again, depending on the circumstances—possibly abusive things to do. But they are not doxing,” Jeong continues. “Do you know what is an abusive thing to do? To expand the definition of doxing in order to harness public outrage without having to actually discuss the circumstances in which you have been exposed.”&lt;/p&gt;
&lt;p&gt;Lavigne only collected information about ICE employees that was related to their work - information that they themselves chose to share publicly. Anyone with a LinkedIn profile could view the same information. While doxxing can be frightening, Lavigne did not share information such as their home addresses, telephone numbers, or other details about their private lives or families.&lt;/p&gt;
&lt;p&gt;The idea that law enforcement officers should be identifiable is not new or radical. This basic transparency measure is why officers have badge numbers and carry identification cards that include their names. This principle was reiterated by the police chief of Hartford, CT (a sanctuary city), who said: “All law enforcement officials, not acting in an undercover capacity, working in our community should be readily identified by the agencies that they represent.”&lt;/p&gt;
&lt;p&gt;ICE agents are no different. When carrying out their public duties, they should be easily identified by the public as both ICE employees and individuals. Failing to identify themselves is &lt;a href=&#34;https://losangeles.cbslocal.com/2017/02/23/la-mayor-to-ice-agents-stop-misidentifying-yourselves/&#34;&gt;cause&lt;/a&gt; &lt;a href=&#34;https://www.kqed.org/news/11642905/s-f-police-commissioners-want-ice-agents-to-stop-impersonating-police&#34;&gt;for&lt;/a&gt; &lt;a href=&#34;https://www.thedailybeast.com/trumps-immigration-goon-squad-pretends-to-be-police-in-nyc&#34;&gt;public&lt;/a&gt; &lt;a href=&#34;https://www.huffingtonpost.com/entry/deceptive-tactics-by-ice-show-why-local-officials-should_us_58f7b3b5e4b0f5cf16c7bba3&#34;&gt;concern&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There are countless instances of very real online harassment and threats—frequently targeted at women, immigrants, queer and trans people, and people of color. In many of these cases, platforms like Twitter have often been &lt;a href=&#34;https://splinternews.com/twitter-is-punishing-users-who-tweeted-our-stephen-mill-1826993497&#34;&gt;far slower to act to remove&lt;/a&gt; content that targets vulnerable people than it does to protect ICE officials participating in a regime separating children from families and deporting hundreds of thousands of immigrants per year.&lt;/p&gt;
&lt;p&gt;Sharing information about government agents related to the execution of their public duties for the purposes of government accountability and transparency should never be considered doxxing or harassment.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/transparency/">Transparency</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/censorship/">Censorship</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/transparency/">transparency</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/censorship/">censorship</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/public-interest/">public interest</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/accountability/">accountability</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Visualizing Cosmological Power Spectra with d3.js</title>
                <link>https://www.redshiftzero.com/post/visualizing-cosmological-power-spectra/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/visualizing-cosmological-power-spectra/</guid>
                <pubDate>Fri, 30 Mar 2018 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Cosmologists make observations of galaxies and radiation in the universe to constrain parameters of the &lt;a href=&#34;https://en.wikipedia.org/wiki/Lambda-CDM_model&#34;&gt;Lambda CDM model &lt;/a&gt;, which is the model that best describes our current understanding of the universe.
These cosmological parameters include quantities like Ω&lt;sub&gt;m&lt;/sub&gt; and Ω&lt;sub&gt;Λ&lt;/sub&gt;,
which describe the matter and &lt;a href=&#34;https://en.wikipedia.org/wiki/Dark_energy&#34;&gt;dark energy&lt;/a&gt; content of the universe respectively.&lt;/p&gt;
&lt;p&gt;Two key observables that constrain these parameters are the &lt;strong&gt;matter power spectrum&lt;/strong&gt; and the &lt;strong&gt;angular power spectrum of the Cosmic Microwave Background&lt;/strong&gt; (CMB) radiation. Let&amp;rsquo;s briefly go over what each of these observables describes.&lt;/p&gt;
&lt;h2 id=&#34;matter-power-spectrum&#34;&gt;Matter Power Spectrum&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/p_k.png&#34; alt=&#34;Matter power spectrum&#34;&gt;&lt;/p&gt;
&lt;p&gt;The matter power spectrum - &lt;em&gt;P(k)&lt;/em&gt; - describes the large scale structure of the universe - it tells us
on which scales matter is distributed. &lt;em&gt;P(k)&lt;/em&gt; is a function of &lt;em&gt;wavenumber&lt;/em&gt; &lt;em&gt;k&lt;/em&gt; which &lt;em&gt;k&lt;/em&gt; corresponds
to inverse scale - so &lt;em&gt;increasing&lt;/em&gt; wavenumber means &lt;em&gt;decreasing&lt;/em&gt; scale.&lt;/p&gt;
&lt;p&gt;For example, using &lt;a href=&#34;https://redshiftzero.github.io/cosmowebapp/&#34;&gt;the visualization&lt;/a&gt;, we can see that by increasing the matter content of the universe, we
increase the power at large wavenumber, which corresponds to smaller scales.
This occurs due to enhanced structure formation as a result of the additional matter content.&lt;/p&gt;
&lt;h2 id=&#34;cmb-angular-power-spectrum&#34;&gt;CMB Angular Power Spectrum&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/cmb.png&#34; alt=&#34;CMB&#34;&gt;&lt;/p&gt;
&lt;p&gt;The Cosmic Microwave Background (CMB) radiation was produced only ~100,000 years after the Big Bang, and gives us information about the universe at these early times. One observable from this radiation is the CMB angular power spectrum, which describes anisotropies in the temperature of the CMB radiation as a function of &lt;em&gt;angular scale&lt;/em&gt;. Since this temperature anisotropy is defined over a sphere, the temperature anisotropy is separated out into angular scales using a multipole expansion (to read how this multipole expansion is done in detail, check out &lt;a href=&#34;http://www.helsinki.fi/~hkurkisu/cpt/Cosmo12.pdf&#34;&gt;these notes (PDF)&lt;/a&gt;). The spectrum &lt;em&gt;C&lt;sub&gt;ℓ&lt;/sub&gt;&lt;/em&gt; (plotted as &lt;em&gt;ℓ(ℓ+1)C&lt;sub&gt;ℓ&lt;/sub&gt;&lt;/em&gt;) is a function of multipole &lt;em&gt;ℓ&lt;/em&gt;, so &lt;em&gt;&lt;em&gt;increasing&lt;/em&gt;&lt;/em&gt; multipole corresponds to &lt;em&gt;decreasing&lt;/em&gt; angular scales.&lt;/p&gt;
&lt;h2 id=&#34;visualizing-power-spectra&#34;&gt;Visualizing Power Spectra&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;Note: This visualization was created in collaboration with &lt;a href=&#34;https://ebaxter.github.io/&#34;&gt;Eric Baxter&lt;/a&gt;, astrophysics postdoc at UPenn.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;To visualize how these power spectra change as a function of cosmological parameters,
we used &lt;code&gt;d3.js&lt;/code&gt;, a popular JavaScript library for creating interactive visualizations.&lt;/p&gt;
&lt;h2 id=&#34;centerlaunch-the-visualization-herehttpsredshiftzerogithubiocosmowebappcenter&#34;&gt;&lt;center&gt;&lt;a href=&#34;https://redshiftzero.github.io/cosmowebapp/&#34;&gt;Launch the visualization here!&lt;/a&gt;&lt;/center&gt;&lt;/h2&gt;
&lt;p&gt;As the user moves a given slider, the spectra are updated by linearly interpolating between the nearest pre-computed spectra.
To create the pre-computed spectra, we used &lt;a href=&#34;https://camb.info/&#34;&gt;CAMB&lt;/a&gt;, a software package for computing power spectra based on input cosmological parameters to generate power and CMB spectra around a fiducial value. We selected a fiducial model from the &lt;a href=&#34;https://arxiv.org/pdf/1502.01589.pdf&#34;&gt;2015 results from the Planck Collaboration (PDF)&lt;/a&gt;. The universe was kept spatially flat (i.e. Ω&lt;sub&gt;m&lt;/sub&gt; + Ω&lt;sub&gt;Λ&lt;/sub&gt; = 1) both because it is a well established constraint and to reduce the amount of data that we needed to generate with CAMB.&lt;/p&gt;
&lt;p&gt;If you&amp;rsquo;d like to check out the code, it&amp;rsquo;s available &lt;a href=&#34;https://github.com/redshiftzero/cosmowebapp&#34;&gt;here on GitHub&lt;/a&gt;. If you&amp;rsquo;d like to learn more about the effect of cosmological parameters on the power spectra, check out &lt;a href=&#34;http://background.uchicago.edu/~whu/intermediate/intermediate.html&#34;&gt;this tutorial&lt;/a&gt;.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/cosmology/">Cosmology</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/javascript/">JavaScript</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/d3.js/">d3.js</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/astrophysics/">astrophysics</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/cosmology/">cosmology</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/d3.js/">d3.js</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/visualization/">visualization</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>How SecureDrop Works 101</title>
                <link>https://www.redshiftzero.com/post/securedrop-101/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/securedrop-101/</guid>
                <pubDate>Fri, 31 Mar 2017 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;When people first learn of the &lt;a href=&#34;https://securedrop.org&#34;&gt;SecureDrop&lt;/a&gt; architecture, it can seem &lt;a href=&#34;https://securedrop.org/media/images/sd_diagram.width-800.png&#34;&gt;quite complicated&lt;/a&gt;. When explaining SecureDrop to people for the first time, it&amp;rsquo;s useful to have a cartoon view providing a broad overview before digging into further technical details (in my experience this is true of any sufficiently technical concept/system). After noticing this confusion from users, I made this quick one-minute video to distill the most important points for the source and journalist workflows:&lt;/p&gt;
&lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34;https://www.youtube.com/embed/LkgN244ggzs&#34; frameborder=&#34;0&#34; allow=&#34;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&#34; allowfullscreen&gt;&lt;/iframe&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/securedrop/">SecureDrop</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/whistleblowing/">whistleblowing</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/securedrop/">SecureDrop</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/101/">101</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/whistleblowing/">whistleblowing</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Inside the Chicago Police Department’s Secret Budget</title>
                <link>https://www.redshiftzero.com/post/cpd-asset-forfeiture/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/cpd-asset-forfeiture/</guid>
                <pubDate>Thu, 29 Sep 2016 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;Every year, police take millions of dollars from Chicagoans through civil asset forfeiture and spend it behind closed doors. In collaboration &lt;a href=&#34;https://www.muckrock.com/project/opening-the-chicago-surveillance-fund-25/&#34;&gt;with Muckrock&lt;/a&gt;, my co-authors and I did  an independent financial audit of this previously undocumented part of the police budget. We demonstrated these asset forfeiture funds are used to circumvent city council oversight and finance controversial surveillance devices. This investigation appeared as a front page feature in the September 29, 2016 issue of the &lt;a href=&#34;https://www.chicagoreader.com/&#34;&gt;Chicago Reader&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.chicagoreader.com/chicago/police-department-civil-forfeiture-investigation/Content?oid=23728922&#34;&gt;Read the full investigation here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.chicagoreader.com/chicago/police-department-civil-forfeiture-investigation/Content?oid=23728922&#34;&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/reader-cover.png&#34; alt=&#34;Reader Cover&#34;&gt;&lt;/a&gt;&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/chicago/">Chicago</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/police/">Police</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/lpl/">LPL</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/police/">police</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/asset-forfeiture/">asset forfeiture</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/foia/">FOIA</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/data-analysis/">data analysis</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Primer on Police Surveillance</title>
                <link>https://www.redshiftzero.com/post/police-surveillance-primer/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/police-surveillance-primer/</guid>
                <pubDate>Tue, 19 Jan 2016 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;&lt;em&gt;I wrote a short primer describing and visualizing police surveillance technology. This project was also posted on the website of the Lucy Parsons Labs.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://redshiftzero.github.io/policesurveillance&#34;&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/police-primer.png&#34; alt=&#34;Primer&#34;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Cameras, automatic license plate readers, cell site simulators and many other surveillance devices are currently used in the city by the Chicago Police Department and its sister agencies. However, many citizens are unaware of the scope of the surveillance systems, their huge cost, and the privacy implications of their use. Lucy Parsons Labs has written a primer on police surveillance devices in the city, and will be updating it as we learn more through our &lt;a href=&#34;https://www.muckrock.com/project/opening-the-chicago-surveillance-fund-25/&#34;&gt;audit in collaboration with Muckrock&lt;/a&gt; and our other investigations.&lt;/p&gt;
&lt;p&gt;Chicago residents have legitimate questions surrounding the use of these techologies: Are appropriate policies and procedures in place to ensure these systems are responsibly used? To what degree are these systems necessary or even useful? Do the benefits of these systems justify the tens of millions of dollars of taxpayer dollars being spent on them? Do members of the public want this level of surveillance to be used?&lt;/p&gt;
&lt;p&gt;In the past, police surveillance of public spaces was constrained by resources such as availability of police officers. However, surveillance technology is producing a significant expansion of police capabilities. Police were historically unable to follow every resident with a police car, but with new surveillance technologies they may be able to effectively accomplish the same goal albeit in a less disruptive manner.&lt;/p&gt;
&lt;p&gt;Members of the public need to recognize the far-reaching implications of giving over this level of power to law enforcement. The transition from police officers having a restricted ability to follow and monitor suspicious people to having pervasive surveillance capabilities is occurring in our city today. We must have public knowledge of surveillance capabilities, policies and procedures in order to have the critical debate about this infrastructure as well as to campaign for transparency and accountability.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://redshiftzero.github.io/policesurveillance&#34;&gt;Check out the full primer here&lt;/a&gt;.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/post/">Post</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/police/">Police</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/surveillance/">Surveillance</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/police/">police</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/surveillance/">surveillance</category>
                                
                            
                        
                    
                
            </item>
        
            <item>
                <title>Manipulation and Machine Learning</title>
                <link>https://www.redshiftzero.com/post/manipulation-ml/</link>
                <guid isPermaLink="true">https://www.redshiftzero.com/post/manipulation-ml/</guid>
                <pubDate>Sat, 29 Aug 2015 00:00:00 &#43;0000</pubDate>
                
                    <author>jen@redshiftzero.com (redshiftzero)</author>
                
                <copyright>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)</copyright>
                
                    <description>&lt;p&gt;&lt;em&gt;This is a writeup of a talk that I gave at Defcon 23&amp;rsquo;s Cryptography and Privacy Village back in August 2015. The presentation included a brief primer on machine learning as some in the audience were unfamiliar with the topic, so skip down to &amp;ldquo;Is there really a problem here?&amp;rdquo; if you are already familiar with ML. Thanks to all who attended and for the excellent questions and comments! References are embedded as links in the text.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&#34;introduction&#34;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;As a society we have an ever-increasing amount of information, data which only has value if we are able to extract meaningful insights - the needle in the haystack. In data science, we use machine learning algorithms and methods like A/B testing to do this. Data science enables us to learn about systems, determine how to optimally make decisions and infer new information not present in the data. These data analysis techniques are incredibly useful and are becoming more powerful due to more and better data as well as the due to the development of increasingly more intelligent systems. These methods have spread into a wide range of areas:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/ml_applications.png&#34; alt=&#34;Machine Learning Applications&#34;&gt;&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s step through a few of the problems that machine learning can be used for:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Advertising: This is probably the most familiar application. The main difference here is that we&amp;rsquo;re increasingly moving from very coarse-grained advertising systems to extremely finely targeted ads.&lt;/li&gt;
&lt;li&gt;Political campaigns: Machine learning is used to build predictive models about individual voters to determine which voters a campaign should target and build experiments that can be used to determine what the optimal action the campaign can take to bring about their desired goal.&lt;/li&gt;
&lt;li&gt;Surveillance: Machine learning can be used to classify people into suspicious or not, such as the system that puts people onto the &lt;a href=&#34;http://www.theguardian.com/us-news/2015/aug/10/us-no-fly-list-predictive-assessments&#34;&gt;no-fly list&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;By machine learning here, we&amp;rsquo;re referring to a set of computer programming techniques that adaptively learn from data: they &lt;em&gt;learn&lt;/em&gt; programs from data instead of requiring a set of rules to be explicitly written down by a programmer.&lt;/p&gt;
&lt;p&gt;For example, if I want to write a program that recognizes handwritten characters, I can write down a list of rules, telling the computer specifically what shapes to expect in a given character. I would need to ensure that the program also can handle different handwriting styles as well as both printed and cursive text. Even for a single character this process could get quite laborious considering the wide variation in handwriting. Instead, one could use supervised machine learning, where a computer learns the rules that best identify a character using many &lt;em&gt;examples&lt;/em&gt; of handwritten letters.&lt;/p&gt;
&lt;p&gt;Supervised learning methods are what we will be focusing on in this discussion. First, we&amp;rsquo;ll look at a cartoon example to set up some nomenclature and build some intuition about how this is done.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s take a canonical classification problem: I want to classify some images into &lt;em&gt;cats&lt;/em&gt;, which I will denote with orange circles, and &lt;em&gt;dogs&lt;/em&gt;, denoted by blue circles. In order to use supervised learning to approach this problem, I must get examples of past images and whether they were classified as a cat or a dog - this is my &lt;em&gt;training set&lt;/em&gt;. I then take both my training and testing data and construct &lt;em&gt;features&lt;/em&gt;, quantities in the data that might be predictive of the &lt;em&gt;target&lt;/em&gt; - whether a given image is a cat or a dog. These features could be quantities as simple as the intensity in a given pixel or the mean color in an image. Here&amp;rsquo;s a cartoon view of these training examples distributed in feature space:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/feature_space.png&#34; alt=&#34;Feature Space&#34;&gt;&lt;/p&gt;
&lt;p&gt;Then we take these examples and their derived features along with a learner - a machine learning algorithm - which will dynamically determine which features are predictive of the label and by how much.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/training_model.png&#34; alt=&#34;Training a model&#34;&gt;&lt;/p&gt;
&lt;p&gt;Then, this trained model can be used with a new example from our testing data to predict for the new example whether or not the image contains a cat or a dog, based on what side of the decision boundary the example falls on.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/new_example.png&#34; alt=&#34;New example&#34;&gt;&lt;/p&gt;
&lt;p&gt;This is a very brief and high level overview of the nomenclature that we&amp;rsquo;ll be using in the remainder of the discussion.&lt;/p&gt;
&lt;h2 id=&#34;is-there-really-a-problem-here&#34;&gt;Is there really a problem here?&lt;/h2&gt;
&lt;p&gt;From the applications I describe above, it&amp;rsquo;s clear that many of these machine learning systems can and will have profound positive impacts on human society. For example, autonomous vehicles have a huge potential for reducing human injury and death due to car accidents, one of the most common causes of death in the United States. Predictive systems can be used to make better use of taxpayer dollars, as well as can help find and correct problems like the use of lead paint in homes before serious damage or injury occurs.&lt;/p&gt;
&lt;p&gt;But these systems are also used for applications that are not as noble, as in the case of mass surveillance. And there might be unintended consequences of relying on systems like these, which the public and sometimes even the designers may not fully understand. We need to make sure that we are thinking about the ramifications of our reliance on machine learning methods with respect to the principles that the privacy advocacy community cares about. In the privacy advocacy community we discuss surveillance a great deal for good reason. So to broaden the scope of the discussion, in this talk I’m going to focus on potential problems due to algorithms beyond surveillance and discuss other issues related to implementation and power. It would be great to have more discussion in both the privacy advocacy and data science communities about this topic.&lt;/p&gt;
&lt;p&gt;In terms of problems that can arise, I&amp;rsquo;ll discuss implementation issues related to biased input data as well as usage issues, when systems are deployed that can be easily misused due to little or no oversight.&lt;/p&gt;
&lt;h3 id=&#34;input-datasets&#34;&gt;Input Datasets&lt;/h3&gt;
&lt;p&gt;As explained in the introduction, these are systems that learn by example. The examples must be representative of the truth. If the input data are not collected in an unbiased way, then the model will be biased in some way. In an ideal world, training datasets would be colleced by random sampling, where the probability of collecting an example is uniform, however, most sampling out there in the real world is not random. Strong selection effects are present in most training data, and in order to generate an accurate model, these need to be understood. Problems arise when input data is treated as unbiased and is used as input to an algorithm which is then treated as impartial and unbiased. Let&amp;rsquo;s go back to our cartoon view of examples in feature space to see why this occurs:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/new_feature_space.png&#34; alt=&#34;Feature Space&#34;&gt;&lt;/p&gt;
&lt;p&gt;Here we have our examples in feature space, with a decision boundary drawn through the examples. But let&amp;rsquo;s zoom out:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/model_unconstrained.png&#34; alt=&#34;Model is unconstrained&#34;&gt;&lt;/p&gt;
&lt;p&gt;We see that the decision boundary extends into regions of feature space that our examples here are not providing much information about. Outside this dotted region, the model is basically unconstrained.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/sparse_examples.png&#34; alt=&#34;Sparse examples in this region of feature space&#34;&gt;&lt;/p&gt;
&lt;p&gt;Even with a few examples, the coverage is so sparse that a few examples don&amp;rsquo;t help the model much.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/biased_model.png&#34; alt=&#34;Model is biased&#34;&gt;&lt;/p&gt;
&lt;p&gt;When the input data is biased in this way, we end up with a highly biased model.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/wrong_models.png&#34; alt=&#34;Model is invalid&#34;&gt;&lt;/p&gt;
&lt;p&gt;The model incorrectly classifies many examples. This is one major issue that is often handled poorly. Let&amp;rsquo;s look at a real world example to see how this might manifest itself in algorithms that are currently in use.&lt;/p&gt;
&lt;h3 id=&#34;predictive-policing&#34;&gt;Predictive Policing&lt;/h3&gt;
&lt;p&gt;Police departments state that they are starting to direct more energy to crime prevention, which is one way that machine learning is used by police departments. The idea is to allocate resources more effectively and enable proactive and preventative policing strategies. Perhaps by allocating police officers to areas where crimes are likely to occur then you can prevent those crimes from even occurring: the mere presence of police will dissuade people from criminal acts. In the same vein, police officers could also surveil those individuals who are considered most likely to commit crimes. Here&amp;rsquo;s how the New York City police commissioner regards predictive policing:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/bratton_quote.png&#34; alt=&#34;Bill Bratton quote&#34;&gt;&lt;/p&gt;
&lt;p&gt;These two types of crime prediction systems are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Individual: Crime probabilities for individual people. Used by the Chicago Police Department, which maintains a &amp;ldquo;Heat List” of people who are considered most likely to commit some violent crime. This is done using network analysis going two hops out.&lt;/li&gt;
&lt;li&gt;Spatially: An approach that is considered more tasteful (in terms of not evoking Minority Report as much) is to predict which areas are likely to have crimes committed in them within some time period. One issue immediately is that since humans tend to cluster and the same individuals tend to aggregate in the same areas, these two approaches are not totally dissimilar.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;One of the major players in this space is a company called PredPol. They have a product that predicts crime probabilities on a spatial basis. On their website they say the following:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/predpol_quote.png&#34; alt=&#34;PredPol quote&#34;&gt;&lt;/p&gt;
&lt;p&gt;Their system does not use individual data: they use only type, place and time of crime. However, statements like this in isolation should in no way reassure people of the unbiased nature of predictive crime systems like these. There are inhereant biases in input data due to selection effects in input data. Selection effects include biases due to people not being equally likely to call the police. In addition, we know that for many crimes, such as marijuana-related offenses, white and black people infract at a similar rate, black people are far more likely to be charged with marijuana-related crimes due to biases in law enforcement.&lt;/p&gt;
&lt;p&gt;If I were to naively feed this crime data into the model, I’ve unevenly sampled feature space, and could very well be oversampled in areas of low socioeconomic status. The model will then not be representative of the truth and policing strategies based on a model will send cops to these poor areas, thus systematizing the discrimination. The real danger here with systems like this is that they could easily become a self-fulfilling prophesy if improperly validated.&lt;/p&gt;
&lt;p&gt;This can be done in a more responsible way. One way to proceed in a scenario like this is to allocate some fraction of your resources to targeting regions of feature space that are poorly constrained by the model. To make this system more fair, you don’t just need &lt;em&gt;more&lt;/em&gt; data but the &lt;em&gt;right&lt;/em&gt; data.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/get_more_data.png&#34; alt=&#34;Get more data in regions of feature space that are poorly populated&#34;&gt;&lt;/p&gt;
&lt;p&gt;There are lots of other ways of dealing with biased training data such as reweighting the training data in feature space. There’s also a body of work in the machine learning literature on fair representations that aim to address some of the issues related to discrimination.&lt;/p&gt;
&lt;p&gt;However, naive use of training sets is just one issue. Spatial aggregation doesn’t wash all these problems away, especially when the aggregation is done over very small areas. Predpol for example aggregates over 500 ft x 500 ft blocks, so this could be only a few houses. In this way aggregated data can still provide identifying information about individuals. Clearly, removing controversial features like race, criminal history, or even generally individual-level information does not magically erase all discriminatory issues with the training data.&lt;/p&gt;
&lt;p&gt;I’m certainly not necessarily condemning all predictive systems here. But these are the sorts of questions we need to be asking manufacturers of these systems to ensure that they have thought carefully about these issues. Currently, there is no formal system to regulate or address these types of discrimination and bias concerns when it comes to machine learning implementation.&lt;/p&gt;
&lt;h3 id=&#34;filtering&#34;&gt;Filtering&lt;/h3&gt;
&lt;p&gt;Even if one is able to construct a system that is perfectly accurate, another concern is how these methods are used. One possibility that has &lt;a href=&#34;https://medium.com/message/engineering-the-public-289c91390225&#34;&gt;been&lt;/a&gt; &lt;a href=&#34;http://www.newrepublic.com/article/117878/information-fiduciary-solution-facebook-digital-gerrymandering&#34;&gt;raised&lt;/a&gt; is the potential for manipulation of algorithms by the organizations that control them, their employees, or by attackers. These manipulations would be difficult to detect due to a current lack of transparancy and accountability.&lt;/p&gt;
&lt;p&gt;A set of algorithms that are natural targets for manipulation are filtering algorithms. Filtering algorithms are necessary due to the firehose of data we are all currently trying to make sense of in our daily lives. We can sort through this data in a variety of ways:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reverse chronological order: Look at the newest items first&lt;/li&gt;
&lt;li&gt;Collaborative filtering: People vote on what they think is important&lt;/li&gt;
&lt;li&gt;Algorithmic filtering: Algorithms decide what should be shown or ranked highly&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;One such algorithm for algorithmic filtering is the Facebook news feed. This system takes a list of potential news feed items, builds features from them, puts them into a modeling system, and then produces an output of some ranked list of news feed items.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/facebook_news_feed.png&#34; alt=&#34;Black box analysis&#34;&gt;&lt;/p&gt;
&lt;p&gt;We have some idea of the features that are important for this system:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Is a trending topic mentioned?&lt;/li&gt;
&lt;li&gt;Is this an important life event? Marriage, congratulations, etc.&lt;/li&gt;
&lt;li&gt;How old is the news item?&lt;/li&gt;
&lt;li&gt;How many likes or comments does this item have? How many likes or comments by people that I know?&lt;/li&gt;
&lt;li&gt;Is offensive (as judged by Facebook) content present?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The operation of this algorithm is important to understand as it determines what updates and news stories a Facebook user gets to see. In a scenario where the platform has over a billion users and a &lt;a href=&#34;http://www.pewresearch.org/fact-tank/2014/09/24/how-social-media-is-reshaping-news/&#34;&gt;huge and increasing segment of the population&lt;/a&gt; relies on Facebook to get their news, we will see that even a small change can have a huge impact.&lt;/p&gt;
&lt;h3 id=&#34;manipulation&#34;&gt;Manipulation&lt;/h3&gt;
&lt;p&gt;One high impact study discussed in the media regarding the manipulation of the Facebook news feed algorithm was &lt;a href=&#34;http://www.pnas.org/content/111/24/8788.full.pdf&#34;&gt;Experimental evidence of massive-scale emotional contagion through social networks&lt;/a&gt;. In this work, Facebook took almost 700k users and segmented them into control groups and positive and negative groups. The positive group was shown more items in their news feed that consisted of positive words. The negative group was shown more items in their news feed that consisted of negative words. Then Facebook observes the news items that are posted in response. And they find that in the positive group, more positive news items are posted, and in the negative group, more negative news items are posted. This is a statistically significant effect, because very tiny differences in the statistical properties of news feed items shown to users can have huge impacts.&lt;/p&gt;
&lt;p&gt;Since you might be wondering, this type of work is legal if you accepted Facebook&amp;rsquo;s Data Use Policy. Agreeing to this document constitutes informed consent for this type of experimentation. Facebook is able to use this type of mechanism to shift people&amp;rsquo;s emotional states.
However, there was &lt;a href=&#34;http://www.nature.com/news/facebook-experiment-boosts-us-voter-turnout-1.11401&#34;&gt;another study&lt;/a&gt; that demonstrated using a similar mechanism, specifically by showing people a message about it being election day and showing them that some of their friends had voted, Facebook can statistically significantly increase the number of people that are likely to go out and vote. This is a lever that can be used to condition entire populations to act in a certain desired direction without them being aware. That’s a very scary idea and is the ultimate in mass social engineering.&lt;/p&gt;
&lt;p&gt;In addition to corporations, their employees, and anyone that may infiltrate these organizations, governments are a natural entity to be interested in such powerful mechanisms of control. I encourage you to take a look at documents &lt;a href=&#34;https://theintercept.com/document/2015/06/22/behavioural-science-support-jtrig/&#34;&gt;like this one&lt;/a&gt; from the UK’s GCHQ examining how to use psychological techniques to condition individuals towards obedience and conformity.&lt;/p&gt;
&lt;p&gt;The issues associated with the usage of these algorithms is their opaque operation on proprietary data. These systems can enable manipulation. For all the issues described with algorithms, we need more information. The lack of information about their operation is the fundamental issue here.&lt;/p&gt;
&lt;p&gt;The real problem is that we have no idea how many of these issues we are detecting. Many of the controversies that have occurred in recent years related to algorithms have been due to papers or admissions by the companies themselves. Both of the studies on manipulating the Facebook news feed were published by Facebook researchers. We need to make sure that we are building tools and advocating for policies that will enable the early detection of manipulation and discrimination and ensure that there is a mechanism for redress.&lt;/p&gt;
&lt;h2 id=&#34;time-for-action&#34;&gt;Time for action&lt;/h2&gt;
&lt;p&gt;The first step is stronger consumer protections. People should know how their data is being used and to that end we need more explicit data use and privacy policies. Users need this so they can make an informed decision. Facebook and other companies should more clearly and explicitly state how they use their users’ data, especially with respect to experimentation. There should also be a capacity for users to opt-out (or even better: opt-into) experimentation. There are bodies like the Federal Trade Commission in the US that can investigate and pursue companies that do not follow their own policies.&lt;/p&gt;
&lt;p&gt;Next, all these systems leverage data. The situation is that the party who has access to the data as well as has the skills and resources to leverage the data has the power. Obviously reducing the amount of data collected helps - something that can be done by building systems that are private by design. For example, there’s a lot of work that has been done in the &lt;a href=&#34;https://www.usenix.org/legacy/event/nsdi11/tech/full_papers/Guha.pdf&#34;&gt;academic&lt;/a&gt; &lt;a href=&#34;https://crypto.stanford.edu/adnostic/adnostic.pdf&#34;&gt;community&lt;/a&gt; on schemes for privacy-preserving targeting advertising.&lt;/p&gt;
&lt;p&gt;Another front to push forward on is advocating independent audits, open algorithms, and transparency. A nice feature from some recommendation systems like amazon is the ability to enable you to determine why a given result was ranked highly, e.g. showing what other items have you purchased. Providing rankings of feature importances is also incredibly useful for transparency reports. Of course, companies have no reason to do these things unless consumers or regulation demands it.&lt;/p&gt;
&lt;p&gt;In terms of technology, one approach is to examine the algorithms themselves with black box analysis: correlating inputs and outputs to study the system in the black box. There is a schematic view of the facebook news feed algorithm. One can generate inputs using test accounts or real accounts. The outputs can be compared and differences in outputs across users can be examined.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://www.redshiftzero.com/img/blackbox_analysis.png&#34; alt=&#34;Black box analysis&#34;&gt;&lt;/p&gt;
&lt;p&gt;One great recent example of how this analysis can be used to increase transparency is &lt;a href=&#34;xray.cs.columbia.edu/&#34;&gt;Xray&lt;/a&gt;. This is a really nice project done in the context of determining how ad placement is performed. The idea is to use test accounts, provide some interesting keywords as input and then see what ads get served in response. This can demonstrate that sensitive topics can be targeted and can also demonstrate data abuse. The group found some nice results when they applied this tool to Gmail: for example, when keywords associated with being in debt were present, they were served ads for new cars. If Google wasn’t reading your email then this wouldn’t be possible. But since they are reading your email, you can apply this type of analysis and find out how they are using your data. Similar techniques could be applied to other platforms. This is an excellent way forward that does not necessarily require the consent of the platforms involved.&lt;/p&gt;
&lt;h2 id=&#34;moving-forward&#34;&gt;Moving Forward&lt;/h2&gt;
&lt;p&gt;To practitioners: We need to be careful that we are using these systems in an equitable and responsible manner. Given biased input data, algorithms are not impartial and should not be treated as such. If we are to design systems that treat people fairly, then we need to be sure we carefully construct these systems not to discriminate.&lt;/p&gt;
&lt;p&gt;And for us advocates, we need to recognize that these methods are extremely powerful and we have to demand more information and more accountability in order to monitor how they are designed and being used. We should push forward with both policy and technology to achieve this. The privacy advocacy community has a big role to play to show people what is being done here, because by and large we don’t know. And we’re not going to know unless we find out.&lt;/p&gt;
</description>
                
                
                
                
                
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/machine-learning/">machine learning</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/categories/ethics/">ethics</category>
                                
                            
                        
                    
                        
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/machine-learning/">machine learning</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/bias/">bias</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/fairness/">fairness</category>
                                
                            
                                
                                
                                
                                    <category domain="https://www.redshiftzero.com/tags/ethics/">ethics</category>
                                
                            
                        
                    
                
            </item>
        
    </channel>
</rss>
