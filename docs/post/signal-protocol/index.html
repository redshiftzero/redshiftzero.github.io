<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark">
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Investigating the Signal Protocol, Part 1: Foundations | redshiftzero</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/modern.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap"
        media="print" onload="this.media='all'" />
    <noscript>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" />
    </noscript>

    <!-- Meta tags -->
    <meta name="author" content="" />
    <meta name="description" content="Investigating the Signal Protocol, Part 1: Foundations" />

    <!-- Icons and manifest -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="redshiftzero" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="redshiftzero" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="/icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- RSS feeds -->
    <link rel="alternate" type="application/atom+xml" href="https://www.redshiftzero.com/atom.xml"
        title="redshiftzero" />
    <link rel="alternate" type="application/rss+xml" href="https://www.redshiftzero.com/rss.xml" title="redshiftzero" />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.redshiftzero.com/post/signal-protocol/" />

    <!-- Open Graph -->
    <meta property="og:title" content="Investigating the Signal Protocol, Part 1: Foundations | redshiftzero" />
    <meta property="og:description" content="Investigating the Signal Protocol, Part 1: Foundations" />
    <meta property="og:url" content="https://www.redshiftzero.com/post/signal-protocol/" />
    <meta property="og:site_name" content="redshiftzero" />
    <meta property="og:locale" content="en" />
    <meta property="og:image" content="https://www.redshiftzero.com/icons/apple-touch-icon.png" />
    <meta property="og:type" content="article" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@redshiftzero" />

    <!-- JSON-LD structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "datePublished": "2020-10-11T00:00:00",
        "dateModified": "2020-10-11T00:00:00",
        "url": "https://www.redshiftzero.com/post/signal-protocol/",
        "description": "Investigating the Signal Protocol, Part 1: Foundations",
        "image": "https://www.redshiftzero.com/icons/apple-touch-icon.png",
        "author": {
            "@type": "Person",
            "url": "https://www.redshiftzero.com/"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)",
        "name": "Investigating the Signal Protocol, Part 1: Foundations | redshiftzero"
    }
    </script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-wrapper">
                <div class="header-inner single">
                    <div class="site-brand">
                        <a href="/" class="brand">redshiftzero</a>
                    </div>

                    <nav class="nav">
                        <ul class="menu" id="menu">

                            <li class="menu-item"><a href="/archive/"><svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 512 512" class="icon archive">
                                        <path
                                            d="M32 32C14.3 32 0 46.3 0 64s14.3 32 32 32h32v32H32C14.3 128 0 142.3 0 160s14.3 32 32 32h32v32H32C14.3 224 0 238.3 0 256s14.3 32 32 32h32v32H32C14.3 320 0 334.3 0 352s14.3 32 32 32h32v32H32C14.3 416 0 430.3 0 448s14.3 32 32 32h448c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32V96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32H32zM96 96h320v320H96V96z" />
                                    </svg><span class="menu-item-name">Archive</span></a></li>
                            <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 496 512" class="icon user-circle">
                                        <path
                                            d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z" />
                                    </svg><span class="menu-item-name">About</span></a></li>

                        </ul>
                    </nav>
                </div>
            </div>
            <input type="checkbox" id="nav-toggle" aria-hidden="true" />
            <label for="nav-toggle" class="nav-toggle"></label>
            <label for="nav-toggle" class="nav-curtain"></label>
        </header>

        <!-- Main content -->
        <main class="main single" id="main">
            <div class="main-inner">
                
                <article class="content post h-entry">
                    <h1 class="post-title p-name">Investigating the Signal Protocol, Part 1: Foundations</h1>

                    <div class="post-meta">
                        <time datetime="2020-10-11T00:00:00" class="post-meta-item published dt-published">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon">
                                <path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/>
                            </svg> 2020.10.11
                        </time>
                    </div>

                    <div class="post-body e-content">
                        <p>I've been investigating applications that use the Signal Protocol in order to determine if the Signal Protocol for asynchronous messaging might be appropriate for use for applying to SecureDrop messaging in the future. In this post are some notes from reading the Signal Protocol specifications, which I thought might be a useful reference and explanation for others. If you notice an error, or have other thoughts on anything here, feel free to drop me a note on <a href="https://twitter.com/redshiftzero">Twitter</a> or by <a href="mailto:jen@redshiftzero.com">email</a>.</p>
<p>The protocol consists of two main parts, one for establishing key agreement between two parties, and another for "ratcheting" or deriving new ephemeral keys from that initial key material.</p>
<h1 id="key-agreement-using-extended-triple-diffie-hellman-x3dh"><a class="toclink" href="#key-agreement-using-extended-triple-diffie-hellman-x3dh">Key Agreement using Extended Triple Diffie-Hellman (X3DH)</a></h1>
<p>This is the process that occurs on first-time messages.</p>
<p><em>The full description is covered in <a href="https://signal.org/docs/specifications/x3dh/">this specification</a>. I use the same nomenclature as the specificiation for ease of comparison.</em></p>
<p>X3DH is used in order to set up a shared secret between two parties. In this scenario we have a a server which is where we'll store information in case either party is offline. We also have our two users:</p>
<ul>
<li>Alice(üëßüèº) who is online.</li>
<li>Bob(üë¶üèΩ) who is offline. But Bob has helpfully published some data to the server for Alice to use to send him secure messages while he's offline.</li>
</ul>
<p>Aliceüëßüèº and Bobüë¶üèΩ will generate several elliptic curve key pairs using either Curve25519 or Curve448. How these curves can be used in Diffie-Hellman key exchange is described in <a href="https://www.ietf.org/rfc/rfc7748.txt">RFC 7748</a>, Section 6.</p>
<p>For Aliceüëßüèº, she has the following public keys:</p>
<ul>
<li>long-term identity public key $IK_A$</li>
<li>emphemeral public key $EK_A$</li>
</ul>
<p>Bobüë¶üèΩ, who recall is offline, has published the following public keys to the server:</p>
<ul>
<li>long-term identity public key $IK_B$</li>
<li>signed public prekey $SPK_B$. Bobüë¶üèΩ will publish new signed prekeys from time to time, which will replace the old one. He obviously publishes both the prekey and the corresponding signature (with his long term identity key). When Bobüë¶üèΩ replaces a prekey, he'll want to delete the private key of the old keypair after waiting a period of time to allow for recently sent messages to be delivered.</li>
<li>$n$ one-time public prekeys $OPK^{1}_{B}$...$OPK_{B}^{n}$. Since these are one-time use, these will eventually run low (especially if Bobüë¶üèΩ here is a popular fellow) so occasionally Bob will upload additional prekeys. When Bob receives a message using a public prekey, he'll use the private key to process the message, and then delete the corresponding private key.</li>
</ul>
<p>When Aliceüëßüèº wants to send an initial message, she:</p>
<ol>
<li>Fetches Bobüë¶üèΩ's long-term identity public key.</li>
<li>Fetches Bobüë¶üèΩ's signed public prekey and the signature. She verifies the signature (and stops if the verification fails).</li>
<li>She fetches one of Bobüë¶üèΩ's one-time public prekeys ($OPK^{1}_{B}$) - if one is available. Else she skips this step.</li>
</ol>
<p>These items are found in a <a href="https://github.com/signalapp/libsignal-protocol-rust/blob/7e1dbcc26e5b681610498eb9fca31338da468be2/src/state/bundle.rs#L14-L24">PreKeyBundle</a>.</p>
<p>Next, four Diffie-Hellman (DH) shared secrets are derived using:</p>
<ol>
<li>Aliceüëßüèº's long term identity key $IK_A$ and Bobüë¶üèΩ's signed pre-key $SPK_B$.</li>
<li>Aliceüëßüèº's emphemeral key $EK_A$ and Bobüë¶üèΩ's long term identity key $IK_B$.</li>
<li>Aliceüëßüèº's emphemeral key $EK_A$ and Bobüë¶üèΩ's signed pre-key $SPK_B$.</li>
<li>Aliceüëßüèº's emphemeral key $EK_A$ and Bobüë¶üèΩ's one-time public prekeys $OPK^{1}_{B}$.</li>
</ol>
<p>Since the private key material for DH secrets 3-4 above will be deleted after use, these provide <em>forward secrecy</em>. This also means that in the future if an attacker collecting ciphertexts is able to compromise Aliceüëßüèº's long-term identity key, the attacker cannot recover all four DH shared secrets since the ephmeral key material is long gone, thus they are unable to decrypt the ciphertexts encrypted using secrets derived from these DH secrets. By using the long-term identity keys - which can be verified using manual verification of safety numbers - in steps 1-2, these steps mutually authenticate Bobüë¶üèΩ and Aliceüëßüèº.</p>
<p>Next, DH outputs 1-3 (and 4 if available) are concatenated and used as an input for HKDF, an HMAC-based Key Derivation Function (KDF). A KDF does what it sounds like: takes some input and produces cryptographically strong key material. HKDF is defined in <a href="https://www.ietf.org/rfc/rfc5869.txt">RFC 5869</a>. In our protocol, the output of HKDF is a shared key $SK$! These three (and sometimes four) DH key exchanges give the protocol its name.</p>
<p>At this point, Aliceüëßüèº can now send a message to Bobüë¶üèΩ. She sends him $IK_A$, $EK_A$, the ID of the one-time prekey she used ($OPK_{B1}$) (Bobüë¶üèΩ will delete the corresponding private key material once he processes the message), and the ciphertext of her message encrypted using the shared key $SK$, which Bobüë¶üèΩ can also derive.</p>
<h3 id="implications"><a class="toclink" href="#implications">Implications</a></h3>
<p>An attacker that is able to compromise the long-term identity key can masquerade as the user. They can sign prekeys and create new sessions. But, provided an attacker does not have access to previous ephemeral prekey (i.e. private) key material - which are deleted in the protocol after use - the attacker will not be able to reconstruct prior $SK$ and thus decrypt previous ciphertexts. If the private keys corresponding to currently uploaded prekeys, either one-time or signed, were compromised, they should be replaced.</p>
<p>The specification also states that rate limits should be in place for getting a one-time prekey: this prevents an attacker from exhausting one-time prekeys, which would force Aliceüëßüèº to fall back to using only Bobüë¶üèΩ's signed prekey.</p>
<h1 id="double-ratchet-algorithm"><a class="toclink" href="#double-ratchet-algorithm">Double Ratchet Algorithm</a></h1>
<p>At this point once the initial shared secret is established, the "ratchet" comes into play.</p>
<p><em>The full description is covered in <a href="https://signal.org/docs/specifications/doubleratchet/">this specification</a> in the Double Ratchet without header encryption section. I use the same nomenclature as the specificiation for ease of comparison.</em></p>
<h2 id="kdf-chain"><a class="toclink" href="#kdf-chain">KDF chain</a></h2>
<p>A KDF chain is when a key and some additional input is used as input to a KDF, producting key material, some of which is used as a new KDF key, and some of which is used as an output key. The output keys are used, and the next step in the KDF chain uses the new KDF key as an input. Each step of the KDF chain looks like the following:</p>
<p><img alt="KDF Chain single step" src="/img/KDFChain.png" /></p>
<h2 id="symmetric-key-ratchet"><a class="toclink" href="#symmetric-key-ratchet">Symmetric-key ratchet</a></h2>
<p>A "symmetric ratchet" is a KDF chain that is used to derive per-message keys. Signal's "Chain key" refers to the KDF key for each of the symmetric-key chains.</p>
<p>A single step in the symmetric key ratchet looks like the following:</p>
<p><img alt="Symmetric ratchet single step" src="/img/SymmetricRatchet.png" /></p>
<h2 id="dh-ratchet"><a class="toclink" href="#dh-ratchet">DH Ratchet</a></h2>
<p>The DH ratchet is the process by which chain keys in the symmetric ratchet are updated.</p>
<p>Each party has a ratchet key pair, which is a public-private Diffie-Hellman key pair.</p>
<p>We observed in the X3DH protocol that in the first message Aliceüëßüèº sent, she included the public part of her emphemeral key $EK_A$ such that bob could derive the same shared secret $SK$.</p>
<p>In subsequent messages, Aliceüëßüèº (and Bobüë¶üèΩ) can advertise new public keys (new "ratchet" public keys), which when Bobüë¶üèΩ (and Aliceüëßüèº) receives he can use to construct new DH ratchet shared secrets using the local corresponding ratchet private key. Aliceüëßüèº and Bobüë¶üèΩ take turns ratcheting the DH secrets forward. Senders must include the sender ratchet key in each Signal message.</p>
<h2 id="signal-protocol"><a class="toclink" href="#signal-protocol">Signal Protocol</a></h2>
<p>Putting this together, Aliceüëßüèº and Bobüë¶üèΩ each have:</p>
<ol>
<li>a DH ratchet</li>
<li>a root (symmetric-key) chain</li>
<li>a sending (symmetric-key) chain</li>
<li>a receiving (symmetric-key) chain</li>
</ol>
<p>Aliceüëßüèº's sending chain and Bobüë¶üèΩ's receiving chain are the same, similarly Aliceüëßüèº's receiving chain and Bobüë¶üèΩ's sending chain also are the same. Output keys from the sending and receiving chains are used for individual message encryption and decryption.</p>
<p>Once a message key is used (i.e. for encryption or deletion), it is deleted by clients. If messages are delivered out of order, the receiver can just ratchet the chain forward to get the key material for the most recent delivered message, and store the message keys from the previous steps until they are delivered.</p>
<p>The root chain takes as input DH secrets from the DH ratchet (derived as described in the prior section). The output keys from the root chain are new chain keys for the sending and receiving chains. As stated above, the message keys from those sending and receiving chains are used to encrypt and decrypt individual messages.</p>
<p>The initial root key for the Double Ratchet protocol is the SK generated from the X3DH protocol. Initially $SPK_{B}$ becomes Bobüë¶üèΩ's initial ratchet keypair.</p>
<h1 id="properties"><a class="toclink" href="#properties">Properties</a></h1>
<p>In summary, in addition to protecting the confidentiality of messages, some other useful properties of the above protocol are:</p>
<ul>
<li><em>Deniability</em> - anyone can claim a message came from one of the participants at the end of a conversation.</li>
<li><em>Forward secrecy</em> - If long-term keys are compromised, prior messages cannot be decrypted. The key material to decrypt them is ephemeral and will have been deleted.</li>
<li><em>Self-healing and "future secrecy"</em> - If a key is compromised, the protocol <em>heals</em>, meaning that future communications will return to a state unknown to the attacker. This is done by updating chain keys using the DH ratchet.</li>
<li><em>Authentication</em> - If key fingerprints are mutually verified, the protocol provides end-to-end authentication.</li>
</ul>
                    </div>
                </article>
            
            </div>
        </main>

        <!-- Back to top -->
        <div id="back-to-top" class="back-to-top">
            <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up">
                    <path
                        d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z" />
                </svg></a>
        </div>

        <!-- Footer -->
        <footer id="footer" class="footer">
            <div class="footer-inner">
                <div class="site-info">¬© 2025 Jennifer Helsby</div>
            </div>
        </footer>
    </div>

    <!-- MathJax -->
    <script>
        if (typeof MathJax === 'undefined') {
            window.MathJax = {
                loader: {
                    load: ['[tex]/mhchem']
                },
                tex: {
                    inlineMath: { '[+]': [['$', '$']] },
                    tags: 'ams',
                    packages: { '[+]': ['mhchem'] }
                }
            };
            (function () {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
                script.defer = true;
                document.head.appendChild(script);
            })();
        } else {
            MathJax.texReset();
            MathJax.typeset();
        }
    </script>

    <!-- Medium Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>
    <script>
        let imgNodes = document.querySelectorAll('div.post-body img');
        imgNodes = Array.from(imgNodes).filter(node => node.parentNode.tagName !== "A");

        mediumZoom(imgNodes, {
            background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
        })
    </script>

    <!-- Instant Page -->
    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>
</body>

</html>