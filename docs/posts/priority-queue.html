<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark">
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Handling equal priority jobs using queue.PriorityQueue | redshiftzero</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/css/modern.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap"
        media="print" onload="this.media='all'" />
    <noscript>
        <link rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap" />
    </noscript>

    <!-- Meta tags -->
    <meta name="author" content="" />
    <meta name="description" content="Handling equal priority jobs using queue.PriorityQueue" />

    <!-- Icons and manifest -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="redshiftzero" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="redshiftzero" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="/icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    <!-- RSS feeds -->
    <link rel="alternate" type="application/atom+xml" href="https://www.redshiftzero.com/atom.xml"
        title="redshiftzero" />
    <link rel="alternate" type="application/rss+xml" href="https://www.redshiftzero.com/rss.xml" title="redshiftzero" />

    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.redshiftzero.com/post/priority-queue/" />

    <!-- Open Graph -->
    <meta property="og:title" content="Handling equal priority jobs using queue.PriorityQueue | redshiftzero" />
    <meta property="og:description" content="Handling equal priority jobs using queue.PriorityQueue" />
    <meta property="og:url" content="https://www.redshiftzero.com/post/priority-queue/" />
    <meta property="og:site_name" content="redshiftzero" />
    <meta property="og:locale" content="en" />
    <meta property="og:image" content="https://www.redshiftzero.com/icons/apple-touch-icon.png" />
    <meta property="og:type" content="article" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@redshiftzero" />

    <!-- JSON-LD structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "datePublished": "2020-01-13T00:00:00",
        "dateModified": "2020-01-13T00:00:00",
        "url": "https://www.redshiftzero.com/post/priority-queue/",
        "description": "Handling equal priority jobs using queue.PriorityQueue",
        "image": "https://www.redshiftzero.com/icons/apple-touch-icon.png",
        "author": {
            "@type": "Person",
            "url": "https://www.redshiftzero.com/"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en)",
        "name": "Handling equal priority jobs using queue.PriorityQueue | redshiftzero"
    }
    </script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-wrapper">
                <div class="header-inner single">
                    <div class="site-brand">
                        <a href="/" class="brand">redshiftzero</a>
                    </div>

                    <nav class="nav">
                        <ul class="menu" id="menu">

                            <li class="menu-item"><a href="/archive/"><svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 512 512" class="icon archive">
                                        <path
                                            d="M32 32C14.3 32 0 46.3 0 64s14.3 32 32 32h32v32H32C14.3 128 0 142.3 0 160s14.3 32 32 32h32v32H32C14.3 224 0 238.3 0 256s14.3 32 32 32h32v32H32C14.3 320 0 334.3 0 352s14.3 32 32 32h32v32H32C14.3 416 0 430.3 0 448s14.3 32 32 32h448c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32v-32h32c17.7 0 32-14.3 32-32s-14.3-32-32-32h-32V96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32H32zM96 96h320v320H96V96z" />
                                    </svg><span class="menu-item-name">Archive</span></a></li>
                            <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 496 512" class="icon user-circle">
                                        <path
                                            d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z" />
                                    </svg><span class="menu-item-name">About</span></a></li>

                        </ul>
                    </nav>
                </div>
            </div>
            <input type="checkbox" id="nav-toggle" aria-hidden="true" />
            <label for="nav-toggle" class="nav-toggle"></label>
            <label for="nav-toggle" class="nav-curtain"></label>
        </header>

        <!-- Main content -->
        <main class="main single" id="main">
            <div class="main-inner">
                
                <article class="content post h-entry">
                    <h1 class="post-title p-name">Handling equal priority jobs using queue.PriorityQueue</h1>

                    <div class="post-meta">
                        <time datetime="2020-01-13T00:00:00" class="post-meta-item published dt-published">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon">
                                <path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/>
                            </svg> 2020.01.13
                        </time>
                    </div>

                    <div class="post-body e-content">
                        <p>A queue retrives items in FIFO (first in, first out) order. A priority queue retrieves item based on <em>priority</em>, higher priority items come first. Well, what happens if you submit items that have equal priorities? It depends on how the priority queue was implemented. Read on for how this is handled in the Python standard library's  <code>queue.PriorityQueue</code>.</p>
<p>Let's see <code>queue.PriorityQueue</code> in action in a simple case:</p>
<pre class="codehilite"><code class="language-py">&gt;&gt;&gt; from queue import PriorityQueue
&gt;&gt;&gt; q = PriorityQueue()
&gt;&gt;&gt; q.put((1, 'A'))
&gt;&gt;&gt; q.put((2, 'B'))
&gt;&gt;&gt; q.put((3, 'C'))
&gt;&gt;&gt; q.get()
(1, 'A')
&gt;&gt;&gt; q.get()
(2, 'B')
&gt;&gt;&gt; q.get()
(3, 'C')
&gt;&gt;&gt; q.empty()
True
</code></pre>

<p>As we can see, we've put <code>(priority_number, data)</code> into the queue, and retrieved them using the <code>get()</code> method. We see that lower numbers correspond to higher priorities. </p>
<p>Let's now add some jobs with equal priorities and retrieve them:</p>
<pre class="codehilite"><code class="language-py">&gt;&gt;&gt; q.put((1, 'My first job'))
&gt;&gt;&gt; q.put((1, 'Another job'))
&gt;&gt;&gt; q.get()
(1, 'Another job')
&gt;&gt;&gt; q.get()
(1, 'My first job')
</code></pre>

<p>We did not retrieve items in FIFO order for jobs of equal priority: <code>'Another job'</code> was fetched prior to <code>'My first job'</code> even though it was added afterwards. Why does this happen?</p>
<h2 id="using-a-min-heap-for-queuepriorityqueue"><a class="toclink" href="#using-a-min-heap-for-queuepriorityqueue">Using a min-heap for <code>queue.PriorityQueue</code></a></h2>
<p>The short version is that we grabbed <code>'Another job'</code> first, because <code>'Another job' &lt; 'My first job'</code> alphabetically.</p>
<p>The longer version is that under the hood, <code>queue.PriorityQueue</code> is implemented using <code>heapq</code>, Python's heap implementation. Every job is an element in a min-heap. A min-heap is a complete binary tree that satisfies the min-heap propety: the value of each node is greater than or equal to the value of its parent. The root element will be the node with the minimum value. So to get the next job we want to run, we just <a href="https://github.com/python/cpython/blob/b2b4a51f7463a0392456f7772f33223e57fa4ccc/Lib/heapq.py#L139">grab the element at the top of the min-heap</a>, which due to the min-heap property, we know will be the job with the minimum priority value - which remember from above corresponds to the <em>higher</em> priority.</p>
<p>But where is this comparison done: <code>'Another job' &lt; 'My first job'</code>? During heap operations, elements are compared with one another (and swapped if needed). In Python, this is done using <a href="https://github.com/python/cpython/blob/b2b4a51f7463a0392456f7772f33223e57fa4ccc/Lib/heapq.py#L264">the rich comparison operator <code>__lt__</code></a>. <code>'Another job'</code> will bubble to the top of the heap since <code>'Another job' &lt; 'My first job'</code>.</p>
<h2 id="how-we-can-solve-this"><a class="toclink" href="#how-we-can-solve-this">How we can solve this</a></h2>
<p>Here's an approach I used for Python 3.5 (the version of Python I was writing for when I looked into using <a href="https://github.com/freedomofpress/securedrop-client/blob/master/securedrop_client/api_jobs/base.py#L24">this functionality</a>). For the application I was working on, I needed to retrieve items based on priority, and for items of equal priority, I needed to retrieve items in FIFO order.</p>
<p>One simple approach if you hit this problem is following <a href="https://docs.python.org/3/library/heapq.html#priority-queue-implementation-notes">a suggestion in the <code>heapq</code> documentation</a>: "store entries as 3-element list including the priority, an entry count, and the task", where the entry count is a tie-breaker for jobs of equal priority. Let's see that demonstrated:</p>
<pre class="codehilite"><code class="language-py">&gt;&gt;&gt; q.put((1, 1, 'My next job'))
&gt;&gt;&gt; q.put((1, 2, 'Another job'))
&gt;&gt;&gt; q.get()
(1, 1, 'My next job')
&gt;&gt;&gt; q.get()
(1, 2, 'Another job')
</code></pre>

<p>In my situation, I was working in a codebase that had already a mediator interface to submit jobs (to <code>queue.PriorityQueue</code>), and job objects themselves were separate objects (i.e. not simple strings in the real applicatoin). I ended up making jobs sortable using the following superclass that implemented the <code>__lt__</code> rich comparison method:</p>
<pre class="codehilite"><code class="language-py">from typing import TypeVar

QueueJobType = TypeVar('QueueJobType', bound='QueueJob')


class QueueJob():
    def __init__(self, order_number: int, task: str) -&gt; None:
        self.order_number = order_number
        self.task = task

    def __lt__(self, other: QueueJobType) -&gt; bool:
        '''
        We need to use the order_number key to break ties to ensure
        that objects are retrieved in FIFO order.
        '''
        return self.order_number &lt; other.order_number

    def __repr__(self) -&gt; str:
        return self.task
</code></pre>

<p>When I submitted jobs, I'd do so using an interface like this (application simplified for demonstration purposes, more context is <a href="https://github.com/freedomofpress/securedrop-client/blob/master/securedrop_client/queue.py">here</a>) that would set the <code>order_number</code> such that it would be monotonically increasing:</p>
<pre class="codehilite"><code class="language-py">import itertools
import queue


class App():
    def __init__(self):
        self.order_number = itertools.count()
        self.queue = queue.PriorityQueue()

    def add_task(self, priority: int, task: str):
        current_order_number = next(self.order_number)
        task = QueueJob(current_order_number, task)
        self.queue.put((priority, task))
</code></pre>

<p>Let's see if jobs with equal priorities are retrieved in FIFO order:</p>
<pre class="codehilite"><code class="language-py">&gt;&gt;&gt; from stuff import App
&gt;&gt;&gt; app = App()
&gt;&gt;&gt; app.add_task(1, 'My first job')
&gt;&gt;&gt; app.add_task(1, 'Another job')
&gt;&gt;&gt; app.queue.get()
(1, My first job)
&gt;&gt;&gt; app.queue.get()
(1, Another job)
</code></pre>

<p>Jobs with equal priorities are retrieved in FIFO order, which is what we wanted.</p>
                    </div>
                </article>
            
            </div>
        </main>

        <!-- Back to top -->
        <div id="back-to-top" class="back-to-top">
            <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up">
                    <path
                        d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z" />
                </svg></a>
        </div>

        <!-- Footer -->
        <footer id="footer" class="footer">
            <div class="footer-inner">
                <div class="site-info">© 2025 Jennifer Helsby</div>
            </div>
        </footer>
    </div>

    <!-- MathJax -->
    <script>
        if (typeof MathJax === 'undefined') {
            window.MathJax = {
                loader: {
                    load: ['[tex]/mhchem']
                },
                tex: {
                    inlineMath: { '[+]': [['$', '$']] },
                    tags: 'ams',
                    packages: { '[+]': ['mhchem'] }
                }
            };
            (function () {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
                script.defer = true;
                document.head.appendChild(script);
            })();
        } else {
            MathJax.texReset();
            MathJax.typeset();
        }
    </script>

    <!-- Medium Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>
    <script>
        let imgNodes = document.querySelectorAll('div.post-body img');
        imgNodes = Array.from(imgNodes).filter(node => node.parentNode.tagName !== "A");

        mediumZoom(imgNodes, {
            background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
        })
    </script>

    <!-- Instant Page -->
    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>
</body>

</html>